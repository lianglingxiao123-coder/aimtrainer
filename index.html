<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¯ ä¸‰è§’æ´²ç»ƒæªè®­ç»ƒè¥</title>
<style>
  :root {
    --bg: #0a0e1a;
    --panel: #111827;
    --border: #1f2937;
    --accent: #00d4ff;
    --accent2: #ff6b35;
    --green: #00ff88;
    --red: #ff3366;
    --text: #e2e8f0;
    --muted: #64748b;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Segoe UI', system-ui, sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    background: var(--panel);
    border-bottom: 1px solid var(--border);
  }
  .logo { font-size: 20px; font-weight: 700; color: var(--accent); letter-spacing: 1px; }
  .logo span { color: var(--accent2); }
  .nav-tabs { display: flex; gap: 4px; }
  .nav-tab {
    padding: 8px 20px; border-radius: 8px; border: none;
    background: transparent; color: var(--muted);
    cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s;
  }
  .nav-tab:hover { color: var(--text); background: var(--border); }
  .nav-tab.active { background: var(--accent); color: #000; font-weight: 700; }

  .page { display: none; }
  .page.active { display: block; }

  /* ===== ARENA ===== */
  #arena-page { height: calc(100vh - 57px); display: none; flex-direction: column; }
  #arena-page.active { display: flex; }

  .arena-hud {
    display: flex; align-items: center; gap: 20px;
    padding: 8px 20px; background: rgba(0,0,0,0.5);
    border-bottom: 1px solid var(--border); flex-wrap: wrap;
  }
  .hud-item { display: flex; flex-direction: column; align-items: center; min-width: 52px; }
  .hud-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; }
  .hud-value { font-size: 20px; font-weight: 700; color: var(--accent); font-variant-numeric: tabular-nums; }
  .hud-value.red { color: var(--red); }
  .hud-value.green { color: var(--green); }
  .hud-sep { flex: 1; }

  .mode-selector { display: flex; gap: 6px; }
  .mode-btn {
    padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border);
    background: transparent; color: var(--muted); cursor: pointer; font-size: 12px; transition: all 0.2s;
  }
  .mode-btn:hover { border-color: var(--accent); color: var(--accent); }
  .mode-btn.active { background: var(--accent); border-color: var(--accent); color: #000; font-weight: 600; }

  .start-btn {
    padding: 8px 22px; border-radius: 8px; border: none;
    background: var(--green); color: #000; font-weight: 700; font-size: 14px;
    cursor: pointer; transition: all 0.2s; white-space: nowrap;
  }
  .start-btn:hover { filter: brightness(1.2); }
  .start-btn.stop { background: var(--red); }

  #canvas-wrap {
    flex: 1; position: relative; overflow: hidden;
    cursor: none;
    background: linear-gradient(180deg, #1a2535 0%, #0d1520 40%, #182030 70%, #1e2a1a 100%);
  }
  #gameCanvas { width: 100%; height: 100%; display: block; }

  /* è‡ªå®šä¹‰å‡†æ˜Ÿ */
  #crosshair {
    position: absolute; pointer-events: none;
    width: 24px; height: 24px;
    transform: translate(-50%, -50%);
  }

  #start-overlay {
    position: absolute; inset: 0;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    background: rgba(0,0,0,0.65); backdrop-filter: blur(4px); gap: 14px;
  }
  #start-overlay h2 { font-size: 30px; color: var(--accent); }
  #start-overlay p { color: var(--muted); font-size: 15px; }
  .big-start {
    margin-top: 8px; padding: 14px 48px; border-radius: 12px; border: none;
    background: var(--green); color: #000; font-weight: 800; font-size: 18px;
    cursor: pointer; letter-spacing: 1px; transition: all 0.2s;
  }
  .big-start:hover { filter: brightness(1.2); transform: scale(1.04); }

  #result-modal {
    position: absolute; inset: 0; display: none;
    align-items: center; justify-content: center;
    background: rgba(0,0,0,0.72); backdrop-filter: blur(6px);
  }
  #result-modal.show { display: flex; }
  .result-card {
    background: var(--panel); border: 1px solid var(--border);
    border-radius: 16px; padding: 32px 40px; min-width: 320px; text-align: center;
  }
  .result-card h2 { font-size: 22px; margin-bottom: 18px; color: var(--accent); }
  .result-row {
    display: flex; justify-content: space-between; padding: 8px 0;
    border-bottom: 1px solid var(--border); font-size: 14px;
  }
  .result-row:last-of-type { border: none; }
  .result-row .val { font-weight: 700; color: var(--green); }
  .result-actions { display: flex; gap: 12px; margin-top: 18px; justify-content: center; }
  .result-actions button {
    padding: 10px 24px; border-radius: 8px; border: none;
    font-weight: 600; cursor: pointer; font-size: 14px; transition: all 0.2s;
  }
  .btn-retry { background: var(--green); color: #000; }
  .btn-retry:hover { filter: brightness(1.1); }
  .btn-close { background: var(--border); color: var(--text); }

  /* å‘½ä¸­ç‰¹æ•ˆ */
  .hit-effect {
    position: absolute; pointer-events: none;
    font-size: 14px; font-weight: 800; color: var(--red);
    text-shadow: 0 0 8px var(--red);
    animation: floatUp 0.7s ease-out forwards;
    white-space: nowrap;
  }
  .hit-effect.headshot { color: #ffd700; text-shadow: 0 0 10px #ffd700; font-size: 16px; }
  .combo-toast {
    position: absolute; pointer-events: none;
    font-size: 17px; font-weight: 800; color: var(--green);
    text-shadow: 0 0 10px var(--green);
    animation: floatUp 0.9s ease-out forwards;
  }
  @keyframes floatUp {
    0% { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-55px) scale(1.2); }
  }

  /* ===== SENSITIVITY ===== */
  #sens-page { padding: 28px 36px; max-width: 900px; margin: 0 auto; }
  #sens-page h2 { font-size: 22px; color: var(--accent); margin-bottom: 6px; }
  #sens-page .sub { color: var(--muted); margin-bottom: 28px; }
  .sens-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
  .sens-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 22px; }
  .sens-card h3 { font-size: 13px; color: var(--muted); margin-bottom: 14px; text-transform: uppercase; letter-spacing: 1px; }
  .slider-row { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
  .slider-row label { display: flex; justify-content: space-between; font-size: 13px; }
  .slider-row label span { color: var(--accent); font-weight: 600; }
  input[type=range] {
    width: 100%; height: 6px; border-radius: 4px; background: var(--border);
    outline: none; cursor: pointer; -webkit-appearance: none;
  }
  input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%;
    background: var(--accent); cursor: pointer; box-shadow: 0 0 8px var(--accent);
  }
  #sens-arena { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 22px; margin-bottom: 20px; }
  #sens-arena h3 { font-size: 13px; color: var(--muted); margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
  #sensCanvas { width: 100%; height: 200px; border-radius: 8px; cursor: crosshair; display: block; background: #080d14; }
  .sens-tip { margin-top: 8px; font-size: 12px; color: var(--muted); text-align: center; }
  .sens-convert { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 22px; }
  .sens-convert h3 { font-size: 13px; color: var(--muted); margin-bottom: 14px; text-transform: uppercase; letter-spacing: 1px; }
  .convert-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
  .convert-item { background: var(--bg); border-radius: 8px; padding: 12px; text-align: center; }
  .convert-item .game-name { font-size: 11px; color: var(--muted); margin-bottom: 5px; }
  .convert-item .sens-val { font-size: 20px; font-weight: 700; color: var(--accent2); }
  .convert-item .sens-unit { font-size: 10px; color: var(--muted); }

  /* ===== STATS ===== */
  #stats-page { padding: 28px 36px; max-width: 900px; margin: 0 auto; }
  #stats-page h2 { font-size: 22px; color: var(--accent); margin-bottom: 6px; }
  #stats-page .sub { color: var(--muted); margin-bottom: 28px; }
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 24px; }
  .stat-card { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; padding: 18px; text-align: center; }
  .stat-card .s-label { font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 7px; }
  .stat-card .s-val { font-size: 26px; font-weight: 800; color: var(--accent); }
  .history-table { background: var(--panel); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
  .history-table h3 { padding: 14px 18px; font-size: 13px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); }
  table { width: 100%; border-collapse: collapse; }
  th { padding: 9px 14px; text-align: left; font-size: 11px; color: var(--muted); border-bottom: 1px solid var(--border); }
  td { padding: 9px 14px; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.04); }
  tr:last-child td { border: none; }
  tr:hover td { background: rgba(255,255,255,0.03); }
  .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
  .tag-s { background: rgba(0,212,255,0.15); color: var(--accent); }
  .tag-a { background: rgba(0,255,136,0.15); color: var(--green); }
  .tag-b { background: rgba(255,107,53,0.15); color: var(--accent2); }
  .tag-c { background: rgba(100,116,139,0.15); color: var(--muted); }
  .clear-btn {
    margin-top: 14px; padding: 7px 18px; border-radius: 8px; border: 1px solid var(--border);
    background: transparent; color: var(--muted); cursor: pointer; font-size: 13px; transition: all 0.2s;
  }
  .clear-btn:hover { border-color: var(--red); color: var(--red); }
</style>
</head>
<body>

<header>
  <div class="logo">ğŸ¯ <span>ä¸‰è§’æ´²</span> ç»ƒæªè®­ç»ƒè¥</div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchPage('arena',this)">ğŸ® è®­ç»ƒåœº</button>
    <button class="nav-tab" onclick="switchPage('sens',this)">âš™ï¸ çµæ•åº¦</button>
    <button class="nav-tab" onclick="switchPage('stats',this)">ğŸ“Š æ•°æ®</button>
  </div>
</header>

<!-- è®­ç»ƒåœº -->
<div id="arena-page" class="page active">
  <div class="arena-hud">
    <div class="hud-item">
      <span class="hud-label">å‘½ä¸­</span>
      <span class="hud-value green" id="hud-hits">0</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">æœªå‘½ä¸­</span>
      <span class="hud-value red" id="hud-miss">0</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">å‘½ä¸­ç‡</span>
      <span class="hud-value" id="hud-acc">-</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">çˆ†å¤´ç‡</span>
      <span class="hud-value" id="hud-hs" style="color:#ffd700">-</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">ååº”æ—¶é—´</span>
      <span class="hud-value" id="hud-rt">-</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">è¿å‡»</span>
      <span class="hud-value" id="hud-combo">x0</span>
    </div>
    <div class="hud-item">
      <span class="hud-label">å‰©ä½™</span>
      <span class="hud-value" id="hud-time">60s</span>
    </div>
    <div class="hud-sep"></div>
    <div class="mode-selector">
      <button class="mode-btn active" id="btn-patrol" onclick="setMode('patrol')">å·¡é€»</button>
      <button class="mode-btn" id="btn-sprint" onclick="setMode('sprint')">å†²åˆº</button>
      <button class="mode-btn" id="btn-peek" onclick="setMode('peek')">æ¢å¤´</button>
      <button class="mode-btn" id="btn-multi" onclick="setMode('multi')">å¤šç›®æ ‡</button>
    </div>
    <button class="start-btn" id="startBtn" onclick="toggleGame()">å¼€å§‹è®­ç»ƒ</button>
  </div>

  <div id="canvas-wrap">
    <canvas id="gameCanvas"></canvas>
    <!-- è‡ªå®šä¹‰å‡†æ˜Ÿ -->
    <svg id="crosshair" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <line x1="12" y1="1" x2="12" y2="8" stroke="#00d4ff" stroke-width="1.5" opacity="0.9"/>
      <line x1="12" y1="16" x2="12" y2="23" stroke="#00d4ff" stroke-width="1.5" opacity="0.9"/>
      <line x1="1" y1="12" x2="8" y2="12" stroke="#00d4ff" stroke-width="1.5" opacity="0.9"/>
      <line x1="16" y1="12" x2="23" y2="12" stroke="#00d4ff" stroke-width="1.5" opacity="0.9"/>
      <circle cx="12" cy="12" r="1.8" fill="#00d4ff" opacity="0.9"/>
    </svg>

    <div id="start-overlay">
      <h2>ğŸ¯ ä¸‰è§’æ´²ç»ƒæªè®­ç»ƒè¥</h2>
      <p>äººå½¢é¶ Â· åœ°é¢æ¨ªç§» Â· çœŸå®æˆ˜åœºèŠ‚å¥</p>
      <p style="font-size:12px;color:#64748b;margin-top:-4px">çˆ†å¤´ +2åˆ† Â· èº«ä½“ +1åˆ† Â· è¿å‡»æœ‰å¥–åŠ±</p>
      <div style="display:flex;gap:28px;margin-top:4px;font-size:13px;color:var(--muted)">
        <span>ğŸª– <b style="color:var(--text)">å·¡é€»</b> â€” æ…¢é€Ÿæ¨ªç§»</span>
        <span>ğŸ’¨ <b style="color:var(--text)">å†²åˆº</b> â€” é«˜é€Ÿå¥”è·‘</span>
        <span>ğŸ‘ï¸ <b style="color:var(--text)">æ¢å¤´</b> â€” æ©ä½“é—ªç°</span>
        <span>ğŸ¯ <b style="color:var(--text)">å¤šç›®æ ‡</b> â€” å¿«é€Ÿåˆ‡æ¢</span>
      </div>
      <button class="big-start" onclick="toggleGame()">â–¶ å¼€å§‹è®­ç»ƒ</button>
    </div>

    <div id="result-modal">
      <div class="result-card">
        <h2>ğŸ† è®­ç»ƒç»“ç®—</h2>
        <div id="result-body"></div>
        <div class="result-actions">
          <button class="btn-retry" onclick="retryGame()">ğŸ”„ å†æ¥ä¸€å±€</button>
          <button class="btn-close" onclick="closeResult()">å…³é—­</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- çµæ•åº¦ -->
<div id="sens-page" class="page">
  <h2>âš™ï¸ çµæ•åº¦è°ƒæ ¡</h2>
  <p class="sub">æ‰¾åˆ°æœ€é€‚åˆä½ çš„çµæ•åº¦ï¼Œåœ¨æµ‹è¯•åœºè·Ÿè¸ªæ¨ªå‘ç§»åŠ¨ç›®æ ‡æ„Ÿå—æ‰‹æ„Ÿ</p>
  <div class="sens-grid">
    <div class="sens-card">
      <h3>é¼ æ ‡è®¾ç½®</h3>
      <div class="slider-row">
        <label>DPI <span id="dpi-val">800</span></label>
        <input type="range" id="dpi" min="400" max="3200" step="100" value="800" oninput="updateSens()">
      </div>
      <div class="slider-row">
        <label>æ¸¸æˆå†…çµæ•åº¦ <span id="igs-val">50</span></label>
        <input type="range" id="igs" min="1" max="100" value="50" oninput="updateSens()">
      </div>
      <div class="slider-row">
        <label>ADS å€ç‡ <span id="ads-val">0.80</span></label>
        <input type="range" id="ads" min="0.3" max="1.0" step="0.05" value="0.8" oninput="updateSens()">
      </div>
    </div>
    <div class="sens-card">
      <h3>360Â° è·ç¦»æ¢ç®—</h3>
      <p style="font-size:12px;color:var(--muted);margin-bottom:14px">æ—‹è½¬360Â°éœ€è¦ç§»åŠ¨é¼ æ ‡çš„è·ç¦»</p>
      <div style="text-align:center">
        <div style="font-size:44px;font-weight:800;color:var(--accent)" id="cm360">--</div>
        <div style="color:var(--muted);margin-top:4px;font-size:13px">å˜ç±³ / 360Â°</div>
      </div>
      <hr style="border-color:var(--border);margin:14px 0">
      <div style="font-size:12px;color:var(--muted);line-height:1.8">
        ğŸ’¡ èŒä¸šç©å®¶å‚è€ƒï¼š<br>
        &nbsp;&nbsp;ä½çµæ•ï¼ˆç²¾å‡†ç‹™å‡»ï¼‰ï¼š40â€“60 cm<br>
        &nbsp;&nbsp;ä¸­çµæ•ï¼ˆå‡è¡¡ï¼‰ï¼š20â€“40 cm<br>
        &nbsp;&nbsp;é«˜çµæ•ï¼ˆå¿«é€Ÿååº”ï¼‰ï¼š10â€“20 cm
      </div>
    </div>
  </div>
  <div id="sens-arena">
    <h3>æ‰‹æ„Ÿæµ‹è¯•åœº â€” æ¨ªå‘å¥”è·‘äººå½¢é¶ï¼ˆæ„Ÿå—å½“å‰çµæ•åº¦ï¼‰</h3>
    <canvas id="sensCanvas"></canvas>
    <p class="sens-tip">åœ¨ç”»å¸ƒä¸Šç§»åŠ¨é¼ æ ‡è·Ÿè¸ªé¶ â€¢ è“ç‚¹ = ä½ çš„å‡†æ˜Ÿ â€¢ è°ƒæ•´çµæ•åº¦ç›´åˆ°è·Ÿè¸ªé¡ºæ‰‹</p>
  </div>
  <div class="sens-convert">
    <h3>å¸¸è§ FPS æ¸¸æˆçµæ•åº¦æ¢ç®—</h3>
    <div class="convert-grid">
      <div class="convert-item"><div class="game-name">ä¸‰è§’æ´²è¡ŒåŠ¨</div><div class="sens-val" id="conv-delta">-</div><div class="sens-unit">çµæ•åº¦</div></div>
      <div class="convert-item"><div class="game-name">CSGO / CS2</div><div class="sens-val" id="conv-cs">-</div><div class="sens-unit">sensitivity</div></div>
      <div class="convert-item"><div class="game-name">Valorant</div><div class="sens-val" id="conv-val">-</div><div class="sens-unit">sensitivity</div></div>
      <div class="convert-item"><div class="game-name">å’Œå¹³ç²¾è‹±</div><div class="sens-val" id="conv-pubg">-</div><div class="sens-unit">çµæ•åº¦</div></div>
      <div class="convert-item"><div class="game-name">Apex Legends</div><div class="sens-val" id="conv-apex">-</div><div class="sens-unit">sensitivity</div></div>
      <div class="convert-item"><div class="game-name">Overwatch 2</div><div class="sens-val" id="conv-ow">-</div><div class="sens-unit">sensitivity</div></div>
    </div>
  </div>
</div>

<!-- ç»Ÿè®¡ -->
<div id="stats-page" class="page">
  <h2>ğŸ“Š è®­ç»ƒæ•°æ®</h2>
  <p class="sub">è¿½è¸ªä½ çš„è¿›æ­¥æ›²çº¿</p>
  <div class="stats-grid">
    <div class="stat-card"><div class="s-label">æ€»è®­ç»ƒå±€æ•°</div><div class="s-val" id="s-total">0</div></div>
    <div class="stat-card"><div class="s-label">å¹³å‡å‘½ä¸­ç‡</div><div class="s-val" id="s-avgacc">0%</div></div>
    <div class="stat-card"><div class="s-label">å¹³å‡ååº”æ—¶é—´</div><div class="s-val" id="s-avgrt">-ms</div></div>
    <div class="stat-card"><div class="s-label">æœ€é«˜è¿å‡»</div><div class="s-val" id="s-combo">0</div></div>
  </div>
  <div class="history-table">
    <h3>ğŸ“‹ è®­ç»ƒè®°å½•</h3>
    <table>
      <thead>
        <tr>
          <th>æ—¶é—´</th><th>æ¨¡å¼</th><th>å‘½ä¸­/æ€»æ•°</th><th>å‘½ä¸­ç‡</th>
          <th>çˆ†å¤´ç‡</th><th>å¹³å‡ååº”</th><th>è¿å‡»</th><th>è¯„çº§</th>
        </tr>
      </thead>
      <tbody id="history-body">
        <tr><td colspan="8" style="text-align:center;color:var(--muted);padding:28px">æš‚æ— è®°å½• ğŸ¯</td></tr>
      </tbody>
    </table>
  </div>
  <button class="clear-btn" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤è®°å½•</button>
</div>

<script>
// ========== é¡µé¢åˆ‡æ¢ ==========
function switchPage(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(name + '-page').classList.add('active');
  btn.classList.add('active');
  if (name === 'sens') initSensCanvas();
  if (name === 'stats') renderStats();
}

// ========== æ¸¸æˆæ ¸å¿ƒ ==========
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const wrap = document.getElementById('canvas-wrap');
const crosshair = document.getElementById('crosshair');

let W, H;
function resizeCanvas() {
  W = canvas.width = wrap.clientWidth;
  H = canvas.height = wrap.clientHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

// å‡†æ˜Ÿè·Ÿéš
let mouseX = 0, mouseY = 0;
wrap.addEventListener('mousemove', e => {
  const r = wrap.getBoundingClientRect();
  mouseX = e.clientX - r.left;
  mouseY = e.clientY - r.top;
  crosshair.style.left = mouseX + 'px';
  crosshair.style.top = mouseY + 'px';
});

// ---- äººå½¢é¶å®šä¹‰ ----
// ç›®æ ‡åœ¨åœ°é¢çº¿é™„è¿‘æ¨ªå‘ç§»åŠ¨
// groundY = H * 0.58ï¼ˆå±å¹•åä¸‹ä¸­çº¿ï¼Œæ¨¡æ‹Ÿåœ°é¢ï¼‰
// äººå½¢é«˜åº¦çº¦ 72pxï¼Œå®½çº¦ 22pxï¼Œå¤´éƒ¨åŠå¾„ 9px

const GROUND_RATIO = 0.58; // åœ°é¢çº¿ä½ç½®ï¼ˆä»é¡¶éƒ¨ï¼‰
const FIGURE_H = 72;       // äººå½¢æ€»é«˜åº¦ï¼ˆå«å¤´ï¼‰
const HEAD_R = 9;          // å¤´éƒ¨åŠå¾„
const BODY_W = 20;         // èº¯å¹²å®½
const BODY_H = 38;         // èº¯å¹²é«˜
// å‚ç›´åˆ†å¸ƒï¼šåœ¨ groundY é™„è¿‘æœ‰ä¸€å®šéšæœºåç§»ï¼ˆÂ±15%ï¼‰ï¼Œæ¨¡æ‹Ÿä¸åŒè·ç¦»
const Y_SPREAD = 0.12;

// ç›®æ ‡ç»“æ„
class Target {
  constructor(mode) {
    this.mode = mode;
    this.alive = true;
    this.hit = false;
    this.hitTimer = 0;
    this.born = Date.now();

    // å‚ç›´ä¸­å¿ƒï¼ˆè„šè¸©åœ¨ groundYï¼Œå¤´é¡¶åœ¨ groundY - FIGURE_Hï¼‰
    // åŠ ä¸Šä¸€ç‚¹éšæœºè®©åœºæ™¯æœ‰å±‚æ¬¡æ„Ÿ
    const gY = H * GROUND_RATIO + (Math.random() - 0.5) * H * Y_SPREAD;
    this.footY = gY;
    this.cy = gY - FIGURE_H / 2; // ä¸­å¿ƒ yï¼ˆç”¨äºç¢°æ’ï¼‰

    // æ°´å¹³ï¼šä»å±å¹•è¾¹ç¼˜å¤–ç”Ÿæˆï¼Œæ¨ªå‘ç§»åŠ¨
    const dir = Math.random() < 0.5 ? 1 : -1;
    this.x = dir > 0 ? -30 : W + 30;
    this.dir = dir;

    // é€Ÿåº¦ï¼ˆå„æ¨¡å¼ä¸åŒï¼‰
    const speeds = { patrol: [90, 140], sprint: [200, 320], peek: [0, 0], multi: [120, 200] };
    const [minS, maxS] = speeds[mode] || [100, 180];
    this.speed = minS + Math.random() * (maxS - minS);

    // æ¢å¤´æ¨¡å¼ï¼šä»æ©ä½“éœ²å‡ºï¼Œåœç•™ï¼Œç„¶åç¼©å›
    if (mode === 'peek') {
      this.peekState = 'in'; // in â†’ visible â†’ out
      this.peekEdge = dir > 0 ? Math.random() * W * 0.4 + W * 0.1 : W - (Math.random() * W * 0.4 + W * 0.1);
      this.peekVisible = 0;
      this.peekDuration = 600 + Math.random() * 800; // åœç•™æ—¶é•¿ ms
      this.speed = 280 + Math.random() * 120;
      this.x = dir > 0 ? this.peekEdge - 60 : this.peekEdge + 60;
    }

    // é—ªç°é¢œè‰²ï¼ˆå‘½ä¸­åå˜çº¢ï¼‰
    this.color = { body: '#4a7a5a', head: '#c8a882', gear: '#3a5a4a' };

    // ç”Ÿå‘½æ—¶é—´ï¼ˆè¶…æ—¶è‡ªåŠ¨æ¶ˆå¤±ï¼Œåªç”¨äº peekï¼‰
    this.lifeMs = 4000;
  }

  // å¤´éƒ¨ç¢°æ’åœ†å¿ƒ (x, headY)
  get headY() { return this.footY - FIGURE_H + HEAD_R; }

  update(dt) {
    if (!this.alive) return;

    if (this.mode === 'peek') {
      if (this.peekState === 'in') {
        // ç§»åŠ¨åˆ° peekEdge
        this.x += this.dir * this.speed * dt;
        const reached = this.dir > 0 ? this.x >= this.peekEdge : this.x <= this.peekEdge;
        if (reached) { this.x = this.peekEdge; this.peekState = 'visible'; this.peekVisible = Date.now(); }
      } else if (this.peekState === 'visible') {
        if (Date.now() - this.peekVisible > this.peekDuration) {
          this.peekState = 'out';
        }
      } else {
        // ç¼©å›å»
        this.x -= this.dir * this.speed * dt;
        const gone = this.dir > 0 ? this.x < this.peekEdge - 80 : this.x > this.peekEdge + 80;
        if (gone) { this.alive = false; }
      }
    } else {
      this.x += this.dir * this.speed * dt;
      // è¶…å‡ºå±å¹•æ¶ˆå¤±
      if (this.x < -60 || this.x > W + 60) this.alive = false;
    }

    // å‘½ä¸­åé—ªçº¢æ¶ˆå¤±
    if (this.hit) {
      this.hitTimer += dt * 1000;
      if (this.hitTimer > 180) this.alive = false;
    }
  }

  draw(ctx) {
    if (!this.alive) return;
    const x = this.x, foot = this.footY;
    const headY = foot - FIGURE_H + HEAD_R;
    const shoulderY = headY + HEAD_R + 3;
    const hipY = shoulderY + BODY_H;

    ctx.save();

    // å‘½ä¸­é—ªçº¢
    const flash = this.hit ? Math.sin(this.hitTimer / 20) > 0 : false;

    // é˜´å½±
    ctx.fillStyle = 'rgba(0,0,0,0.25)';
    ctx.beginPath();
    ctx.ellipse(x, foot + 2, 14, 4, 0, 0, Math.PI * 2);
    ctx.fill();

    // è…¿ï¼ˆä¸¤æ¡çº¿ï¼‰
    ctx.strokeStyle = flash ? '#ff3366' : '#3a5a3a';
    ctx.lineWidth = 6;
    ctx.lineCap = 'round';
    // èµ°è·¯æ‘†è…¿åŠ¨ç”»
    const walkPhase = (Date.now() / 200) * this.dir;
    const legSwing = Math.sin(walkPhase) * (this.mode === 'sprint' ? 12 : 7);
    if (this.mode !== 'peek' || this.peekState === 'in' || this.peekState === 'out') {
      ctx.beginPath(); ctx.moveTo(x - 4, hipY); ctx.lineTo(x - 5 + legSwing, foot); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(x + 4, hipY); ctx.lineTo(x + 5 - legSwing, foot); ctx.stroke();
    } else {
      // æ¢å¤´æ—¶ç«™ç«‹
      ctx.beginPath(); ctx.moveTo(x - 4, hipY); ctx.lineTo(x - 5, foot); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(x + 4, hipY); ctx.lineTo(x + 5, foot); ctx.stroke();
    }

    // èº¯å¹²
    ctx.fillStyle = flash ? '#ff3366' : this.color.gear;
    ctx.strokeStyle = flash ? '#ff3366' : '#2a4a2a';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.roundRect(x - BODY_W/2, shoulderY, BODY_W, BODY_H, 4);
    ctx.fill(); ctx.stroke();

    // æ­¦å™¨ï¼ˆæ­¥æªè½®å»“ï¼‰
    const gunDir = this.dir;
    ctx.fillStyle = flash ? '#ff3366' : '#222';
    ctx.save();
    ctx.translate(x + gunDir * 6, shoulderY + 10);
    ctx.fillRect(gunDir > 0 ? 0 : -26, -3, 26, 5);  // æªç®¡
    ctx.fillRect(gunDir > 0 ? -4 : -2, -6, 8, 12); // æ¡æŠŠ
    ctx.restore();

    // æ‰‹è‡‚
    ctx.strokeStyle = flash ? '#ff3366' : this.color.gear;
    ctx.lineWidth = 5;
    ctx.lineCap = 'round';
    const armSwing = -Math.sin(walkPhase) * 5;
    ctx.beginPath(); ctx.moveTo(x - BODY_W/2, shoulderY + 6); ctx.lineTo(x - BODY_W/2 - 6, shoulderY + 18 + armSwing); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x + BODY_W/2, shoulderY + 6); ctx.lineTo(x + BODY_W/2 + 8 * gunDir, shoulderY + 12); ctx.stroke();

    // å¤´éƒ¨
    ctx.fillStyle = flash ? '#ff3366' : this.color.head;
    ctx.strokeStyle = flash ? '#ff3366' : '#a07050';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.arc(x, headY, HEAD_R, 0, Math.PI * 2);
    ctx.fill(); ctx.stroke();

    // å¤´ç›”
    ctx.fillStyle = flash ? '#ff3366' : this.color.gear;
    ctx.beginPath();
    ctx.ellipse(x, headY - 2, HEAD_R + 1, HEAD_R * 0.7, 0, Math.PI, 0);
    ctx.fill();

    // è·ç¦»æ„Ÿï¼šè¿œå¤„ç›®æ ‡ç”»å°ä¸€äº›ï¼ˆé€šè¿‡ globalAlpha æ¨¡æ‹Ÿï¼‰
    ctx.restore();
  }

  // åˆ¤æ–­æ˜¯å¦å‘½ä¸­ï¼Œè¿”å› 'head' | 'body' | null
  checkHit(mx, my) {
    // åæ ‡è½¬æ¢ï¼ˆcanvas åæ ‡ï¼‰
    const headY = this.footY - FIGURE_H + HEAD_R;
    const shoulderY = headY + HEAD_R + 3;

    // å¤´éƒ¨ç¢°æ’
    const dh = Math.hypot(mx - this.x, my - headY);
    if (dh < HEAD_R + 5) return 'head';

    // èº¯å¹²ç¢°æ’
    if (mx > this.x - BODY_W/2 - 6 && mx < this.x + BODY_W/2 + 6 &&
        my > shoulderY - 4 && my < shoulderY + BODY_H + 4) return 'body';

    // è…¿éƒ¨ï¼ˆå®½æ¾ä¸€ç‚¹ï¼‰
    if (mx > this.x - 10 && mx < this.x + 10 &&
        my > shoulderY + BODY_H && my < this.footY + 4) return 'body';

    return null;
  }
}

// ========== æ¸¸æˆçŠ¶æ€ ==========
let GS = {
  running: false, mode: 'patrol',
  hits: 0, misses: 0, headshots: 0, combo: 0, maxCombo: 0,
  reactionTimes: [], timeLeft: 60,
  targets: [], animFrame: null, timer: null, spawnInterval: null,
  lastFrame: 0,
};

function setMode(m) {
  GS.mode = m;
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('btn-' + m).classList.add('active');
}

function toggleGame() {
  GS.running ? stopGame() : startGame();
}

function startGame() {
  document.getElementById('start-overlay').style.display = 'none';
  document.getElementById('result-modal').classList.remove('show');
  Object.assign(GS, {
    running: true, hits: 0, misses: 0, headshots: 0, combo: 0, maxCombo: 0,
    reactionTimes: [], timeLeft: 60, targets: [], lastFrame: performance.now(),
  });
  const btn = document.getElementById('startBtn');
  btn.textContent = 'â¹ åœæ­¢'; btn.classList.add('stop');
  updateHUD();

  // ç”Ÿæˆç¬¬ä¸€æ‰¹
  spawnTargets();

  // å®šæ—¶ç”Ÿæˆ
  const spawnMs = { patrol: 2200, sprint: 1600, peek: 2000, multi: 1200 }[GS.mode] || 2000;
  GS.spawnInterval = setInterval(spawnTargets, spawnMs);

  GS.timer = setInterval(() => {
    GS.timeLeft--;
    document.getElementById('hud-time').textContent = GS.timeLeft + 's';
    if (GS.timeLeft <= 0) stopGame(true);
  }, 1000);

  requestAnimationFrame(gameLoop);
}

function spawnTargets() {
  if (!GS.running) return;
  // æ¸…ç†æ­»äº¡ç›®æ ‡
  GS.targets = GS.targets.filter(t => t.alive);

  const maxTargets = GS.mode === 'multi' ? 3 : 1;
  const toSpawn = maxTargets - GS.targets.length;
  for (let i = 0; i < toSpawn; i++) {
    GS.targets.push(new Target(GS.mode));
  }
}

function gameLoop(ts) {
  if (!GS.running) return;
  const dt = Math.min((ts - GS.lastFrame) / 1000, 0.05);
  GS.lastFrame = ts;

  // æ›´æ–°
  GS.targets.forEach(t => t.update(dt));
  GS.targets = GS.targets.filter(t => t.alive);

  // è¶…æ—¶æœªå‘½ä¸­ï¼ˆpeek / patrol æ‰ç®—missï¼‰
  // ç›®æ ‡è‡ªç„¶ç¦»åœºä¸è®¡ missï¼Œåªæœ‰ç©å®¶ä¸»åŠ¨ç‚¹ç©ºæ‰ç®—

  // ç»˜åˆ¶
  drawScene();

  GS.animFrame = requestAnimationFrame(gameLoop);
}

function drawScene() {
  ctx.clearRect(0, 0, W, H);

  // å¤©ç©ºæ¸å˜
  const sky = ctx.createLinearGradient(0, 0, 0, H * 0.55);
  sky.addColorStop(0, '#1a2a3f');
  sky.addColorStop(1, '#2a3f55');
  ctx.fillStyle = sky;
  ctx.fillRect(0, 0, W, H * 0.55);

  // è¿œå±±è½®å»“
  drawMountains();

  // åœ°é¢
  const groundY = H * GROUND_RATIO;
  const ground = ctx.createLinearGradient(0, groundY, 0, H);
  ground.addColorStop(0, '#2a3a1e');
  ground.addColorStop(0.3, '#1e2e14');
  ground.addColorStop(1, '#111a0a');
  ctx.fillStyle = ground;
  ctx.fillRect(0, groundY, W, H - groundY);

  // åœ°é¢çº¿ï¼ˆæœ‰ç‚¹çº¹ç†æ„Ÿï¼‰
  ctx.strokeStyle = 'rgba(80,120,50,0.4)';
  ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(0, groundY); ctx.lineTo(W, groundY); ctx.stroke();

  // æ©ä½“ï¼ˆpeek æ¨¡å¼æ˜¾ç¤ºï¼‰
  if (GS.mode === 'peek') drawCover();

  // è·ç¦»æ ‡å°ºï¼ˆåœ°é¢ä¸Šçš„çº¿ï¼Œå¢åŠ ä¸´åœºæ„Ÿï¼‰
  for (let d = 0; d < 5; d++) {
    const y = groundY + d * (H - groundY) / 5;
    ctx.strokeStyle = `rgba(60,100,40,${0.08 - d * 0.01})`;
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
  }

  // ç»˜åˆ¶æ‰€æœ‰ç›®æ ‡ï¼ˆæŒ‰ footY æ’åºï¼Œè¿œçš„å…ˆç”»ï¼‰
  GS.targets.sort((a, b) => a.footY - b.footY).forEach(t => t.draw(ctx));

  // å‡†æ˜ŸåŒºåŸŸæç¤ºçº¿ï¼ˆä¸­çº¿é™„è¿‘æ·¡æ·¡çš„æ ‡æ³¨ï¼‰
  ctx.strokeStyle = 'rgba(0,212,255,0.06)';
  ctx.lineWidth = 1;
  ctx.setLineDash([8, 12]);
  ctx.beginPath(); ctx.moveTo(0, groundY - FIGURE_H/2); ctx.lineTo(W, groundY - FIGURE_H/2);
  ctx.stroke();
  ctx.setLineDash([]);
}

function drawMountains() {
  ctx.fillStyle = '#1e3040';
  ctx.beginPath();
  ctx.moveTo(0, H * 0.52);
  let x = 0;
  while (x < W) {
    const w = 80 + Math.random() * 120;
    const h = 60 + Math.random() * 80;
    ctx.lineTo(x + w/2, H * 0.52 - h);
    ctx.lineTo(x + w, H * 0.52);
    x += w;
  }
  ctx.lineTo(W, H * 0.52);
  ctx.closePath();
  ctx.fill();
  // å‰æ™¯æ ‘æœ¨è½®å»“
  ctx.fillStyle = '#162510';
  for (let tx = 0; tx < W; tx += 28 + Math.random() * 20) {
    const th = 30 + Math.random() * 40;
    ctx.fillRect(tx, H * GROUND_RATIO - th, 5 + Math.random() * 4, th);
  }
}

// è®°ä¸€ä¸‹å±±çš„éšæœºç§å­ï¼ˆé˜²æ­¢æ¯å¸§é‡ç»˜æŠ–åŠ¨ï¼‰
let mountainDrawn = false, mountainCanvas;
function getMountainCanvas() {
  if (!mountainCanvas || mountainCanvas.width !== W) {
    mountainCanvas = document.createElement('canvas');
    mountainCanvas.width = W; mountainCanvas.height = H;
    const mc = mountainCanvas.getContext('2d');
    mc.fillStyle = '#1e3040';
    mc.beginPath(); mc.moveTo(0, H * 0.52);
    let x = 0;
    const rng = seededRand(42);
    while (x < W) {
      const w = 80 + rng() * 120, h = 60 + rng() * 80;
      mc.lineTo(x + w/2, H * 0.52 - h); mc.lineTo(x + w, H * 0.52); x += w;
    }
    mc.lineTo(W, H * 0.52); mc.closePath(); mc.fill();
    mc.fillStyle = '#162510';
    const rng2 = seededRand(99);
    for (let tx = 0; tx < W; tx += 28 + rng2() * 20) {
      const th = 30 + rng2() * 40;
      mc.fillRect(tx, H * GROUND_RATIO - th, 5 + rng2() * 4, th);
    }
  }
  return mountainCanvas;
}

function seededRand(seed) {
  let s = seed;
  return () => { s = (s * 16807 + 0) % 2147483647; return (s - 1) / 2147483646; };
}

// é‡å†™ drawScene ç”¨ç¼“å­˜èƒŒæ™¯
function drawScene() {
  ctx.clearRect(0, 0, W, H);
  const groundY = H * GROUND_RATIO;

  // å¤©ç©º
  const sky = ctx.createLinearGradient(0, 0, 0, groundY);
  sky.addColorStop(0, '#1a2535'); sky.addColorStop(1, '#243550');
  ctx.fillStyle = sky; ctx.fillRect(0, 0, W, groundY);

  // å±±ï¼ˆç¼“å­˜ï¼‰
  try { ctx.drawImage(getMountainCanvas(), 0, 0); } catch(e) { /* skip */ }

  // åœ°é¢
  const ground = ctx.createLinearGradient(0, groundY, 0, H);
  ground.addColorStop(0, '#263a18'); ground.addColorStop(0.4, '#1a2810'); ground.addColorStop(1, '#0e1708');
  ctx.fillStyle = ground; ctx.fillRect(0, groundY, W, H - groundY);
  ctx.strokeStyle = 'rgba(80,130,50,0.5)'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(0, groundY); ctx.lineTo(W, groundY); ctx.stroke();

  // æ©ä½“
  if (GS.mode === 'peek') drawCover();

  // ç›®æ ‡ï¼ˆæŒ‰è¿œè¿‘æ’åºï¼‰
  GS.targets.sort((a,b) => a.footY - b.footY).forEach(t => t.draw(ctx));

  // ä¸­çº¿ç„å‡†æç¤º
  ctx.strokeStyle = 'rgba(0,212,255,0.05)';
  ctx.lineWidth = 1; ctx.setLineDash([6,14]);
  ctx.beginPath(); ctx.moveTo(0, groundY - FIGURE_H * 0.55); ctx.lineTo(W, groundY - FIGURE_H * 0.55); ctx.stroke();
  ctx.setLineDash([]);
}

function drawCover() {
  // ç®€å•çš„æ©ä½“æ–¹å—
  const groundY = H * GROUND_RATIO;
  ctx.fillStyle = '#3a3020';
  ctx.strokeStyle = '#2a2010';
  ctx.lineWidth = 2;
  [[W*0.15, groundY-40, 55, 40], [W*0.55, groundY-50, 65, 50], [W*0.8, groundY-35, 50, 35]].forEach(([x,y,w,h])=>{
    ctx.fillRect(x, y, w, h); ctx.strokeRect(x, y, w, h);
    // æ²™è¢‹çº¹ç†
    ctx.fillStyle = '#4a3828';
    ctx.fillRect(x+4, y+6, w-8, 10); ctx.fillRect(x+4, y+22, w-8, 10);
    ctx.fillStyle = '#3a3020';
  });
}

// ç‚¹å‡»äº‹ä»¶
wrap.addEventListener('click', e => {
  if (!GS.running) return;
  const rect = canvas.getBoundingClientRect();
  const scaleX = W / rect.width, scaleY = H / rect.height;
  const cx = (e.clientX - rect.left) * scaleX;
  const cy = (e.clientY - rect.top) * scaleY;

  let hitAny = false;
  for (const t of GS.targets) {
    if (!t.alive || t.hit) continue;
    const result = t.checkHit(cx, cy);
    if (result) {
      t.hit = true;
      const rt = Date.now() - t.born;
      GS.reactionTimes.push(rt);
      GS.hits++;
      if (result === 'head') GS.headshots++;
      GS.combo++;
      if (GS.combo > GS.maxCombo) GS.maxCombo = GS.combo;
      hitAny = true;
      updateHUD();
      showHitEffect(e.clientX - rect.left, e.clientY - rect.top, result);
      break;
    }
  }
  if (!hitAny) {
    GS.misses++;
    GS.combo = 0;
    updateHUD();
    // ç©ºå‡»é—ªçƒ
    showMissEffect(e.clientX - rect.left, e.clientY - rect.top);
  }
});

function showHitEffect(x, y, type) {
  const el = document.createElement('div');
  el.className = 'hit-effect' + (type === 'head' ? ' headshot' : '');
  el.textContent = type === 'head' ? 'ğŸ’¥ çˆ†å¤´!' : (GS.combo >= 3 ? `ğŸ”¥ x${GS.combo}` : 'âœ“');
  el.style.left = (x - 20) + 'px'; el.style.top = (y - 10) + 'px';
  wrap.appendChild(el);
  setTimeout(() => el.remove(), 700);
}

function showMissEffect(x, y) {
  const el = document.createElement('div');
  el.className = 'hit-effect';
  el.style.color = '#64748b';
  el.textContent = 'âœ—';
  el.style.left = (x - 6) + 'px'; el.style.top = (y - 10) + 'px';
  wrap.appendChild(el);
  setTimeout(() => el.remove(), 500);
}

function updateHUD() {
  const total = GS.hits + GS.misses;
  const acc = total > 0 ? Math.round(GS.hits / total * 100) + '%' : '-';
  const hs = GS.hits > 0 ? Math.round(GS.headshots / GS.hits * 100) + '%' : '-';
  const avgRt = GS.reactionTimes.length > 0
    ? Math.round(GS.reactionTimes.reduce((a,b)=>a+b,0)/GS.reactionTimes.length) + 'ms' : '-';
  document.getElementById('hud-hits').textContent = GS.hits;
  document.getElementById('hud-miss').textContent = GS.misses;
  document.getElementById('hud-acc').textContent = acc;
  document.getElementById('hud-hs').textContent = hs;
  document.getElementById('hud-rt').textContent = avgRt;
  document.getElementById('hud-combo').textContent = 'x' + GS.combo;
}

function stopGame(showResult = true) {
  GS.running = false;
  clearInterval(GS.timer); clearInterval(GS.spawnInterval);
  cancelAnimationFrame(GS.animFrame);
  ctx.clearRect(0, 0, W, H);
  const btn = document.getElementById('startBtn');
  btn.textContent = 'å¼€å§‹è®­ç»ƒ'; btn.classList.remove('stop');
  document.getElementById('hud-time').textContent = '60s';
  if (showResult && (GS.hits + GS.misses > 0)) showResultModal();
  else document.getElementById('start-overlay').style.display = 'flex';
}

function showResultModal() {
  const total = GS.hits + GS.misses;
  const acc = total > 0 ? Math.round(GS.hits / total * 100) : 0;
  const hs = GS.hits > 0 ? Math.round(GS.headshots / GS.hits * 100) : 0;
  const avgRt = GS.reactionTimes.length > 0
    ? Math.round(GS.reactionTimes.reduce((a,b)=>a+b,0)/GS.reactionTimes.length) : 0;
  const grade = acc >= 85 ? 'S' : acc >= 70 ? 'A' : acc >= 55 ? 'B' : 'C';
  const gc = {S:'#00d4ff',A:'#00ff88',B:'#ff6b35',C:'#64748b'}[grade];
  const modeNames = {patrol:'å·¡é€»æ¨¡å¼',sprint:'å†²åˆºæ¨¡å¼',peek:'æ¢å¤´æ¨¡å¼',multi:'å¤šç›®æ ‡'};
  document.getElementById('result-body').innerHTML = `
    <div class="result-row"><span>æ¨¡å¼</span><span class="val">${modeNames[GS.mode]}</span></div>
    <div class="result-row"><span>å‘½ä¸­ / æ€»å°„å‡»</span><span class="val">${GS.hits} / ${total}</span></div>
    <div class="result-row"><span>å‘½ä¸­ç‡</span><span class="val">${acc}%</span></div>
    <div class="result-row"><span>çˆ†å¤´ç‡</span><span class="val" style="color:#ffd700">${hs}%</span></div>
    <div class="result-row"><span>å¹³å‡ååº”æ—¶é—´</span><span class="val">${avgRt}ms</span></div>
    <div class="result-row"><span>æœ€é«˜è¿å‡»</span><span class="val">x${GS.maxCombo}</span></div>
    <div class="result-row"><span>è¯„çº§</span><span class="val" style="color:${gc};font-size:26px">${grade}</span></div>
  `;
  document.getElementById('result-modal').classList.add('show');
  saveRecord({ acc, hs, avgRt, combo: GS.maxCombo, grade, hits: GS.hits, total, mode: GS.mode, time: new Date().toLocaleString('zh-CN') });
}

function retryGame() { closeResult(); setTimeout(startGame, 80); }
function closeResult() {
  document.getElementById('result-modal').classList.remove('show');
  document.getElementById('start-overlay').style.display = 'flex';
}

// ========== çµæ•åº¦ ==========
let sensCtx2, sensTarget2, sensMouseX = -1, sensMouseY = -1, sensAnimId;

function initSensCanvas() {
  if (sensAnimId) cancelAnimationFrame(sensAnimId);
  const sc = document.getElementById('sensCanvas');
  sc.width = sc.parentElement.clientWidth - 44;
  sc.height = 200;
  sensCtx2 = sc.getContext('2d');
  const gY = sc.height * 0.7;
  sensTarget2 = { x: sc.width/2, footY: gY, vx: 1.6, vy: 0 };
  sc.addEventListener('mousemove', e => {
    const r = sc.getBoundingClientRect();
    sensMouseX = (e.clientX - r.left) * (sc.width / r.width);
    sensMouseY = (e.clientY - r.top) * (sc.height / r.height);
  });
  function loop() {
    const w = sc.width, h = sc.height;
    sensCtx2.fillStyle = '#0a0e1a'; sensCtx2.fillRect(0,0,w,h);
    sensCtx2.fillStyle = '#1a2a18'; sensCtx2.fillRect(0, gY, w, h-gY);
    sensCtx2.strokeStyle = 'rgba(80,130,50,0.4)'; sensCtx2.lineWidth = 1;
    sensCtx2.beginPath(); sensCtx2.moveTo(0,gY); sensCtx2.lineTo(w,gY); sensCtx2.stroke();

    sensTarget2.x += sensTarget2.vx;
    if (sensTarget2.x < 30 || sensTarget2.x > w-30) sensTarget2.vx *= -1;

    // ç”»äººå½¢
    const tx = sensTarget2.x, foot = sensTarget2.footY;
    const headY = foot - 52 + 9;
    sensCtx2.fillStyle = '#4a7a5a';
    sensCtx2.beginPath(); sensCtx2.roundRect(tx-10, headY+12, 20, 28, 3); sensCtx2.fill();
    sensCtx2.fillStyle = '#c8a882';
    sensCtx2.beginPath(); sensCtx2.arc(tx, headY, 9, 0, Math.PI*2); sensCtx2.fill();

    // é¼ æ ‡ç‚¹
    if (sensMouseX > 0) {
      sensCtx2.strokeStyle = 'rgba(0,212,255,0.3)'; sensCtx2.setLineDash([4,6]);
      sensCtx2.beginPath(); sensCtx2.moveTo(sensMouseX, sensMouseY); sensCtx2.lineTo(tx, headY); sensCtx2.stroke();
      sensCtx2.setLineDash([]);
      sensCtx2.fillStyle = '#00d4ff'; sensCtx2.shadowColor = '#00d4ff'; sensCtx2.shadowBlur = 8;
      sensCtx2.beginPath(); sensCtx2.arc(sensMouseX, sensMouseY, 4, 0, Math.PI*2); sensCtx2.fill();
      sensCtx2.shadowBlur = 0;
    }
    sensAnimId = requestAnimationFrame(loop);
  }
  loop();
  updateSens();
}

function updateSens() {
  const dpi = +document.getElementById('dpi').value;
  const igs = +document.getElementById('igs').value;
  const ads = +document.getElementById('ads').value;
  document.getElementById('dpi-val').textContent = dpi;
  document.getElementById('igs-val').textContent = igs;
  document.getElementById('ads-val').textContent = ads.toFixed(2);
  const eDPI = dpi * (igs / 100) * 2;
  const cm360 = (2.54 * 360) / (eDPI * 0.022);
  document.getElementById('cm360').textContent = cm360.toFixed(1);
  document.getElementById('conv-delta').textContent = igs;
  document.getElementById('conv-cs').textContent = (eDPI / dpi / 3.18).toFixed(2);
  document.getElementById('conv-val').textContent = (eDPI / dpi / 3.18 * 1.2).toFixed(2);
  document.getElementById('conv-pubg').textContent = Math.round(igs * 0.8);
  document.getElementById('conv-apex').textContent = (eDPI / dpi / 3.18 * 1.5).toFixed(2);
  document.getElementById('conv-ow').textContent = (eDPI / dpi / 3.18 * 10.6).toFixed(1);
}

// ========== ç»Ÿè®¡ ==========
function saveRecord(r) {
  const h = JSON.parse(localStorage.getItem('aimtrainer_v2') || '[]');
  h.unshift(r); if (h.length > 50) h.pop();
  localStorage.setItem('aimtrainer_v2', JSON.stringify(h));
}
function renderStats() {
  const h = JSON.parse(localStorage.getItem('aimtrainer_v2') || '[]');
  document.getElementById('s-total').textContent = h.length;
  if (h.length > 0) {
    document.getElementById('s-avgacc').textContent = Math.round(h.reduce((a,b)=>a+b.acc,0)/h.length) + '%';
    const rts = h.filter(r=>r.avgRt>0);
    document.getElementById('s-avgrt').textContent = rts.length ? Math.round(rts.reduce((a,b)=>a+b.avgRt,0)/rts.length) + 'ms' : '-';
    document.getElementById('s-combo').textContent = Math.max(...h.map(r=>r.combo));
  }
  const tbody = document.getElementById('history-body');
  if (!h.length) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:24px">æš‚æ— è®°å½• ğŸ¯</td></tr>'; return; }
  const mn = {patrol:'å·¡é€»',sprint:'å†²åˆº',peek:'æ¢å¤´',multi:'å¤šç›®æ ‡'};
  tbody.innerHTML = h.map(r=>`<tr>
    <td>${r.time}</td><td>${mn[r.mode]||r.mode}</td>
    <td>${r.hits}/${r.total}</td><td>${r.acc}%</td>
    <td style="color:#ffd700">${r.hs||'-'}%</td>
    <td>${r.avgRt||'-'}ms</td><td>x${r.combo}</td>
    <td><span class="tag tag-${r.grade.toLowerCase()}">${r.grade}</span></td>
  </tr>`).join('');
}
function clearHistory() {
  if (confirm('ç¡®å®šæ¸…é™¤æ‰€æœ‰è®­ç»ƒè®°å½•ï¼Ÿ')) { localStorage.removeItem('aimtrainer_v2'); renderStats(); }
}
</script>
</body>
</html>
