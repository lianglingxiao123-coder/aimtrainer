<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ¯ ä¸‰è§’æ´²ç»ƒæªè®­ç»ƒè¥ v1.3</title>
<style>
  :root {
    --bg: #0a0e1a; --panel: #111827; --border: #1f2937;
    --accent: #00d4ff; --accent2: #ff6b35;
    --green: #00ff88; --red: #ff3366; --text: #e2e8f0; --muted: #64748b;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:'Segoe UI',system-ui,sans-serif; min-height:100vh; overflow-x:hidden; }

  header { display:flex; align-items:center; justify-content:space-between; padding:10px 22px; background:var(--panel); border-bottom:1px solid var(--border); }
  .logo { font-size:19px; font-weight:700; color:var(--accent); letter-spacing:1px; }
  .logo span { color:var(--accent2); }
  .nav-tabs { display:flex; gap:4px; }
  .nav-tab { padding:7px 18px; border-radius:8px; border:none; background:transparent; color:var(--muted); cursor:pointer; font-size:13px; font-weight:500; transition:all .2s; }
  .nav-tab:hover { color:var(--text); background:var(--border); }
  .nav-tab.active { background:var(--accent); color:#000; font-weight:700; }

  .page { display:none; }
  .page.active { display:block; }

  /* Arena */
  #arena-page { height:calc(100vh - 53px); display:none; flex-direction:column; }
  #arena-page.active { display:flex; }
  .arena-hud { display:flex; align-items:center; gap:16px; padding:7px 18px; background:rgba(0,0,0,.55); border-bottom:1px solid var(--border); flex-wrap:wrap; }
  .hud-item { display:flex; flex-direction:column; align-items:center; min-width:48px; }
  .hud-label { font-size:9px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; }
  .hud-value { font-size:19px; font-weight:700; color:var(--accent); font-variant-numeric:tabular-nums; }
  .hud-value.red { color:var(--red); }
  .hud-value.green { color:var(--green); }
  .hud-sep { flex:1; }
  .mode-selector { display:flex; gap:5px; }
  .mode-btn { padding:5px 11px; border-radius:6px; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; font-size:12px; transition:all .2s; }
  .mode-btn:hover { border-color:var(--accent); color:var(--accent); }
  .mode-btn.active { background:var(--accent); border-color:var(--accent); color:#000; font-weight:600; }
  .start-btn { padding:7px 20px; border-radius:8px; border:none; background:var(--green); color:#000; font-weight:700; font-size:13px; cursor:pointer; transition:all .2s; white-space:nowrap; }
  .start-btn:hover { filter:brightness(1.2); }
  .start-btn.stop { background:var(--red); }

  #canvas-wrap { flex:1; position:relative; overflow:hidden; cursor:none; user-select:none; }
  #gameCanvas { width:100%; height:100%; display:block; }
  #crosshair { position:absolute; pointer-events:none; width:24px; height:24px; transform:translate(-50%,-50%); }

  #start-overlay { position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; background:rgba(0,0,0,.65); backdrop-filter:blur(4px); gap:12px; }
  #start-overlay h2 { font-size:28px; color:var(--accent); }
  #start-overlay p { color:var(--muted); font-size:14px; }
  .big-start { margin-top:8px; padding:13px 46px; border-radius:12px; border:none; background:var(--green); color:#000; font-weight:800; font-size:17px; cursor:pointer; transition:all .2s; }
  .big-start:hover { filter:brightness(1.2); transform:scale(1.04); }

  #result-modal { position:absolute; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,.72); backdrop-filter:blur(6px); }
  #result-modal.show { display:flex; }
  .result-card { background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:28px 38px; min-width:300px; text-align:center; }
  .result-card h2 { font-size:20px; margin-bottom:16px; color:var(--accent); }
  .result-row { display:flex; justify-content:space-between; padding:7px 0; border-bottom:1px solid var(--border); font-size:13px; }
  .result-row:last-of-type { border:none; }
  .result-row .val { font-weight:700; color:var(--green); }
  .result-actions { display:flex; gap:10px; margin-top:16px; justify-content:center; }
  .result-actions button { padding:9px 22px; border-radius:8px; border:none; font-weight:600; cursor:pointer; font-size:13px; transition:all .2s; }
  .btn-retry { background:var(--green); color:#000; }
  .btn-close { background:var(--border); color:var(--text); }

  .fx { position:absolute; pointer-events:none; font-size:13px; font-weight:800; animation:floatUp .65s ease-out forwards; white-space:nowrap; }
  .fx.hs { color:#ffd700; font-size:15px; text-shadow:0 0 8px #ffd700; }
  .fx.miss { color:#475569; }
  @keyframes floatUp { 0%{opacity:1;transform:translateY(0) scale(1)} 100%{opacity:0;transform:translateY(-50px) scale(1.1)} }

  /* Sensitivity */
  #sens-page { padding:26px 34px; max-width:880px; margin:0 auto; }
  #sens-page h2 { font-size:21px; color:var(--accent); margin-bottom:5px; }
  .sub { color:var(--muted); margin-bottom:24px; font-size:13px; }
  .sens-grid { display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-bottom:20px; }
  .card { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:20px; }
  .card h3 { font-size:12px; color:var(--muted); margin-bottom:12px; text-transform:uppercase; letter-spacing:1px; }
  .slider-row { display:flex; flex-direction:column; gap:5px; margin-bottom:12px; }
  .slider-row label { display:flex; justify-content:space-between; font-size:13px; }
  .slider-row label span { color:var(--accent); font-weight:600; }
  input[type=range] { width:100%; height:5px; border-radius:3px; background:var(--border); outline:none; cursor:pointer; -webkit-appearance:none; }
  input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; width:16px; height:16px; border-radius:50%; background:var(--accent); cursor:pointer; box-shadow:0 0 6px var(--accent); }
  #sensCanvas { width:100%; height:180px; border-radius:8px; cursor:crosshair; display:block; background:#080d14; }
  .convert-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:9px; }
  .ci { background:var(--bg); border-radius:8px; padding:11px; text-align:center; }
  .ci .gn { font-size:11px; color:var(--muted); margin-bottom:4px; }
  .ci .sv { font-size:19px; font-weight:700; color:var(--accent2); }
  .ci .su { font-size:10px; color:var(--muted); }

  /* Stats */
  #stats-page { padding:26px 34px; max-width:880px; margin:0 auto; }
  #stats-page h2 { font-size:21px; color:var(--accent); margin-bottom:5px; }
  .stats-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:13px; margin-bottom:20px; }
  .sc { background:var(--panel); border:1px solid var(--border); border-radius:11px; padding:16px; text-align:center; }
  .sc .sl { font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:6px; }
  .sc .sv { font-size:24px; font-weight:800; color:var(--accent); }
  .ht { background:var(--panel); border:1px solid var(--border); border-radius:11px; overflow:hidden; }
  .ht h3 { padding:12px 16px; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; border-bottom:1px solid var(--border); }
  table { width:100%; border-collapse:collapse; }
  th { padding:8px 13px; text-align:left; font-size:11px; color:var(--muted); border-bottom:1px solid var(--border); }
  td { padding:8px 13px; font-size:12px; border-bottom:1px solid rgba(255,255,255,.04); }
  tr:last-child td { border:none; }
  tr:hover td { background:rgba(255,255,255,.03); }
  .tag { display:inline-block; padding:2px 7px; border-radius:3px; font-size:10px; font-weight:600; }
  .tag-s { background:rgba(0,212,255,.15); color:var(--accent); }
  .tag-a { background:rgba(0,255,136,.15); color:var(--green); }
  .tag-b { background:rgba(255,107,53,.15); color:var(--accent2); }
  .tag-c { background:rgba(100,116,139,.15); color:var(--muted); }
  .clear-btn { margin-top:12px; padding:6px 16px; border-radius:7px; border:1px solid var(--border); background:transparent; color:var(--muted); cursor:pointer; font-size:12px; transition:all .2s; }
  .clear-btn:hover { border-color:var(--red); color:var(--red); }
</style>
</head>
<body>

<header>
  <div class="logo">ğŸ¯ <span>ä¸‰è§’æ´²</span> ç»ƒæªè®­ç»ƒè¥ <small style="font-size:11px;opacity:.6;font-weight:400">v1.3</small></div>
  <div class="nav-tabs">
    <button class="nav-tab active" onclick="switchPage('arena',this)">ğŸ® è®­ç»ƒåœº</button>
    <button class="nav-tab" onclick="switchPage('sens',this)">âš™ï¸ çµæ•åº¦</button>
    <button class="nav-tab" onclick="switchPage('stats',this)">ğŸ“Š æ•°æ®</button>
  </div>
</header>

<div id="arena-page" class="page active">
  <div class="arena-hud">
    <div class="hud-item"><span class="hud-label">âœ… å‡»æ€</span><span class="hud-value green" id="hud-kills">0</span></div>
    <div class="hud-item"><span class="hud-label">ğŸ’¨ æ¼æ‰</span><span class="hud-value red" id="hud-escaped">0</span></div>
    <div class="hud-item"><span class="hud-label">å‘½ä¸­</span><span class="hud-value green" id="hud-hits">0</span></div>
    <div class="hud-item"><span class="hud-label">æœªå‘½ä¸­</span><span class="hud-value red" id="hud-miss">0</span></div>
    <div class="hud-item"><span class="hud-label">å‘½ä¸­ç‡</span><span class="hud-value" id="hud-acc">-</span></div>
    <div class="hud-item"><span class="hud-label">çˆ†å¤´ç‡</span><span class="hud-value" id="hud-hs" style="color:#ffd700">-</span></div>
    <div class="hud-item"><span class="hud-label">è¿å‡»</span><span class="hud-value" id="hud-combo">x0</span></div>
    <div class="hud-item"><span class="hud-label">å‰©ä½™</span><span class="hud-value" id="hud-time">60s</span></div>
    <div class="hud-sep"></div>
    <div class="mode-selector">
      <button class="mode-btn active" id="btn-sprint" onclick="setMode('sprint')">å†²åˆº</button>
      <button class="mode-btn" id="btn-peek" onclick="setMode('peek')">æ¢å¤´</button>
      <button class="mode-btn" id="btn-multi" onclick="setMode('multi')">å¤šç›®æ ‡</button>
    </div>
    <button class="start-btn" id="startBtn" onclick="toggleGame()">å¼€å§‹è®­ç»ƒ</button>
  </div>
  <div id="canvas-wrap">
    <canvas id="gameCanvas"></canvas>
    <svg id="crosshair" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
      <line x1="12" y1="1" x2="12" y2="8" stroke="#00d4ff" stroke-width="1.5" opacity=".9"/>
      <line x1="12" y1="16" x2="12" y2="23" stroke="#00d4ff" stroke-width="1.5" opacity=".9"/>
      <line x1="1" y1="12" x2="8" y2="12" stroke="#00d4ff" stroke-width="1.5" opacity=".9"/>
      <line x1="16" y1="12" x2="23" y2="12" stroke="#00d4ff" stroke-width="1.5" opacity=".9"/>
      <circle cx="12" cy="12" r="1.8" fill="#00d4ff" opacity=".9"/>
    </svg>
    <div id="start-overlay">
      <h2>ğŸ¯ ä¸‰è§’æ´²ç»ƒæªè®­ç»ƒè¥</h2>
      <p>çœŸå®äººå½¢ Â· éšæœºå‡ºç° Â· æŠ˜è¿”é—ªé¿ Â· 2ç§’è‡ªåŠ¨æ¶ˆå¤±</p>
      <p style="font-size:12px;color:#475569">çˆ†å¤´ -50è¡€ Â· èº«ä½“ -25è¡€ Â· å››è‚¢ -12è¡€ Â· æŒç»­å°„å‡»æœ‰åååŠ›</p>
      <div style="display:flex;gap:22px;margin-top:6px;font-size:12px;color:var(--muted)">
        <span>ğŸª– å·¡é€» â€” æ…¢é€Ÿæ¨ªç§»</span>
        <span>ğŸ’¨ å†²åˆº â€” é«˜é€Ÿå¥”è·‘</span>
        <span>ğŸ‘ï¸ æ¢å¤´ â€” æ©ä½“é—ªç°</span>
        <span>ğŸ¯ å¤šç›®æ ‡ â€” å¿«é€Ÿåˆ‡æ¢</span>
      </div>
      <button class="big-start" onclick="toggleGame()">â–¶ å¼€å§‹è®­ç»ƒ</button>
    </div>
    <div id="result-modal">
      <div class="result-card">
        <h2>ğŸ† è®­ç»ƒç»“ç®—</h2>
        <div id="result-body"></div>
        <div class="result-actions">
          <button class="btn-retry" onclick="retryGame()">ğŸ”„ å†æ¥</button>
          <button class="btn-close" onclick="closeResult()">å…³é—­</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="sens-page" class="page">
  <h2>âš™ï¸ çµæ•åº¦è°ƒæ ¡</h2>
  <p class="sub">è°ƒæ•´å‚æ•°æ„Ÿå—æ‰‹æ„Ÿï¼Œæ‰¾åˆ°æœ€é€‚åˆä½ çš„è®¾ç½®</p>
  <div class="sens-grid">
    <div class="card">
      <h3>é¼ æ ‡è®¾ç½®</h3>
      <div class="slider-row"><label>DPI <span id="dpi-val">800</span></label><input type="range" id="dpi" min="400" max="3200" step="100" value="800" oninput="updateSens()"></div>
      <div class="slider-row"><label>æ¸¸æˆå†…çµæ•åº¦ <span id="igs-val">50</span></label><input type="range" id="igs" min="1" max="100" value="50" oninput="updateSens()"></div>
      <div class="slider-row"><label>ADS å€ç‡ <span id="ads-val">0.80</span></label><input type="range" id="ads" min="0.3" max="1.0" step="0.05" value="0.8" oninput="updateSens()"></div>
    </div>
    <div class="card">
      <h3>360Â° è·ç¦»</h3>
      <p style="font-size:12px;color:var(--muted);margin-bottom:12px">æ—‹è½¬360Â°éœ€è¦ç§»åŠ¨çš„é¼ æ ‡è·ç¦»</p>
      <div style="text-align:center"><div style="font-size:42px;font-weight:800;color:var(--accent)" id="cm360">--</div><div style="color:var(--muted);font-size:12px;margin-top:3px">å˜ç±³ / 360Â°</div></div>
      <hr style="border-color:var(--border);margin:12px 0">
      <div style="font-size:11px;color:var(--muted);line-height:1.9">ğŸ’¡ èŒä¸šå‚è€ƒï¼š<br>&nbsp;ä½æ•ï¼ˆç²¾å‡†ï¼‰ï¼š40â€“60cm &nbsp;ä¸­æ•ï¼š20â€“40cm &nbsp;é«˜æ•ï¼š10â€“20cm</div>
    </div>
  </div>
  <div class="card" style="margin-bottom:18px">
    <h3>æ‰‹æ„Ÿæµ‹è¯•åœº â€” æ¨ªå‘ç§»åŠ¨äººå½¢é¶</h3>
    <canvas id="sensCanvas"></canvas>
    <p style="font-size:11px;color:var(--muted);text-align:center;margin-top:7px">ç§»åŠ¨é¼ æ ‡è·Ÿè¸ªé¶å¿ƒ â€¢ è“ç‚¹=å‡†æ˜Ÿ â€¢ è°ƒæ•´çµæ•åº¦ç›´åˆ°é¡ºæ‰‹</p>
  </div>
  <div class="card">
    <h3>å¸¸è§ FPS çµæ•åº¦æ¢ç®—</h3>
    <div class="convert-grid">
      <div class="ci"><div class="gn">ä¸‰è§’æ´²è¡ŒåŠ¨</div><div class="sv" id="conv-delta">-</div><div class="su">çµæ•åº¦</div></div>
      <div class="ci"><div class="gn">CSGO / CS2</div><div class="sv" id="conv-cs">-</div><div class="su">sensitivity</div></div>
      <div class="ci"><div class="gn">Valorant</div><div class="sv" id="conv-val">-</div><div class="su">sensitivity</div></div>
      <div class="ci"><div class="gn">å’Œå¹³ç²¾è‹±</div><div class="sv" id="conv-pubg">-</div><div class="su">çµæ•åº¦</div></div>
      <div class="ci"><div class="gn">Apex Legends</div><div class="sv" id="conv-apex">-</div><div class="su">sensitivity</div></div>
      <div class="ci"><div class="gn">Overwatch 2</div><div class="sv" id="conv-ow">-</div><div class="su">sensitivity</div></div>
    </div>
  </div>
</div>

<div id="stats-page" class="page">
  <h2>ğŸ“Š è®­ç»ƒæ•°æ®</h2>
  <p class="sub">è¿½è¸ªä½ çš„è¿›æ­¥æ›²çº¿</p>
  <div class="stats-grid">
    <div class="sc"><div class="sl">æ€»å±€æ•°</div><div class="sv" id="s-total">0</div></div>
    <div class="sc"><div class="sl">å¹³å‡å‘½ä¸­ç‡</div><div class="sv" id="s-avgacc">0%</div></div>
    <div class="sc"><div class="sl">å¹³å‡ååº”</div><div class="sv" id="s-avgrt">-</div></div>
    <div class="sc"><div class="sl">æœ€é«˜è¿å‡»</div><div class="sv" id="s-combo">0</div></div>
  </div>
  <div class="ht">
    <h3>ğŸ“‹ è®­ç»ƒè®°å½•</h3>
    <table><thead><tr><th>æ—¶é—´</th><th>æ¨¡å¼</th><th>å‡»æ€</th><th>å‘½ä¸­ç‡</th><th>çˆ†å¤´ç‡</th><th>ååº”</th><th>è¿å‡»</th><th>è¯„çº§</th></tr></thead>
    <tbody id="history-body"><tr><td colspan="8" style="text-align:center;color:var(--muted);padding:24px">æš‚æ— è®°å½• ğŸ¯</td></tr></tbody></table>
  </div>
  <button class="clear-btn" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤è®°å½•</button>
</div>

<script>
function switchPage(n,btn){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById(n+'-page').classList.add('active');
  btn.classList.add('active');
  if(n==='sens') initSensCanvas();
  if(n==='stats') renderStats();
}

// â”€â”€ roundRect polyfill â”€â”€
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect=function(x,y,w,h,r){
    r=Math.min(r,w/2,h/2);
    this.beginPath();
    this.moveTo(x+r,y);
    this.lineTo(x+w-r,y); this.arcTo(x+w,y,x+w,y+r,r);
    this.lineTo(x+w,y+h-r); this.arcTo(x+w,y+h,x+w-r,y+h,r);
    this.lineTo(x+r,y+h); this.arcTo(x,y+h,x,y+h-r,r);
    this.lineTo(x,y+r); this.arcTo(x,y,x+r,y,r);
    this.closePath();
  };
}

// â”€â”€ Canvas è®¾ç½® â”€â”€
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const wrap = document.getElementById('canvas-wrap');
const crosshairEl = document.getElementById('crosshair');
let W, H;
let bgCache = null; // å¿…é¡»åœ¨ resize() ä¹‹å‰å£°æ˜

function resize(){
  W = canvas.width = wrap.clientWidth;
  H = canvas.height = wrap.clientHeight;
  bgCache = null;
}
resize();
window.addEventListener('resize', resize);

// â”€â”€ å‡†æ˜Ÿ â”€â”€
let mouseX = 0, mouseY = 0;
wrap.addEventListener('mousemove', e => {
  const r = wrap.getBoundingClientRect();
  mouseX = e.clientX - r.left;
  mouseY = e.clientY - r.top;
  crosshairEl.style.left = mouseX + 'px';
  crosshairEl.style.top  = mouseY + 'px';
});

// â”€â”€ åååŠ›çŠ¶æ€ â”€â”€
let recoilY = 0;          // å½“å‰ç´¯è®¡åååŠ›ï¼ˆåƒç´ ï¼Œå‡†æ˜Ÿå‘ä¸Šåç§»ï¼‰
let recoilX = 0;          // æ°´å¹³æŠ–åŠ¨
const RECOIL_PER_SHOT = 7;   // æ¯å‘ä¸Šè·³åƒç´ 
const RECOIL_HORIZ    = 3.5; // æ°´å¹³éšæœºæŠ–åŠ¨å¹…åº¦
const RECOIL_RECOVERY = 200; // æ¯ç§’æ¢å¤åƒç´ 
const RECOIL_MAX      = 80;  // æœ€å¤§ç´¯ç§¯

// â”€â”€ å°„å‡»å‚æ•° â”€â”€
let mouseDown = false, shootTimer = null;
const FIRE_RATE = 100; // msï¼Œçº¦10å‘/ç§’

// â”€â”€ äººä½“æ¯”ä¾‹å¸¸é‡ï¼ˆ7å¤´èº«ï¼‰â”€â”€
// ä»¥ BASE_SCALE=1 æ—¶ æ€»é«˜=175px ä¸ºåŸºå‡†
const TOTAL_H_BASE   = 175;
const HEAD_FRAC      = 1/7;      // å¤´å 1/7
const TORSO_FRAC     = 2.5/7;    // èº¯å¹²2.5å¤´
const LEG_FRAC       = 3.5/7;    // è…¿3.5å¤´ï¼ˆå¤§è…¿1.75+å°è…¿1.75ï¼‰
// å®½åº¦
const TORSO_W_RATIO  = 1.45;     // è‚©å®½/å¤´å®½
const WAIST_W_RATIO  = 0.92;     // è…°å®½/è‚©å®½
const ARM_W_RATIO    = 0.38;     // æ‰‹è‡‚çº¿å®½/å¤´å®½
const LEG_W_RATIO    = 0.48;     // è…¿çº¿å®½/å¤´å®½

// ä¼¤å®³
const HP_MAX   = 100;
const DMG_HEAD = 50;
const DMG_BODY = 25;
const DMG_LIMB = 12;

// ç›®æ ‡å­˜æ´»æ—¶é™
const TARGET_LIFETIME = 2000;

// è·ç¦»èŒƒå›´ï¼ˆæ§åˆ¶ç¼©æ”¾ï¼‰
const DIST_MIN = 0.42, DIST_MAX = 1.0;
const GROUND_RATIO = 0.62;

// â”€â”€ èƒŒæ™¯ç¼“å­˜ â”€â”€
function seeded(seed){ let s=seed; return ()=>{ s=(s*16807)%2147483647; return(s-1)/2147483646; }; }

function getBg(){
  if(bgCache && bgCache.width===W && bgCache.height===H) return bgCache;
  bgCache = document.createElement('canvas');
  bgCache.width = W; bgCache.height = H;
  const mc = bgCache.getContext('2d');
  const gY = H * GROUND_RATIO;
  const rng = seeded(37), rng2 = seeded(91);
  const sky = mc.createLinearGradient(0,0,0,gY);
  sky.addColorStop(0,'#141e2e'); sky.addColorStop(1,'#1e3045');
  mc.fillStyle = sky; mc.fillRect(0,0,W,gY);
  mc.fillStyle = '#1a2e40';
  mc.beginPath(); mc.moveTo(0,gY);
  let x=0;
  while(x<W){ const mw=90+rng()*130,mh=55+rng()*85; mc.lineTo(x+mw/2,gY-mh); mc.lineTo(x+mw,gY); x+=mw; }
  mc.lineTo(W,gY); mc.closePath(); mc.fill();
  mc.fillStyle='#112010';
  for(let tx=0;tx<W;tx+=20+rng2()*25){
    const th=25+rng2()*38,tw=4+rng2()*4;
    mc.fillRect(tx,gY-th,tw,th);
  }
  const gr=mc.createLinearGradient(0,gY,0,H);
  gr.addColorStop(0,'#243a16'); gr.addColorStop(.4,'#182a10'); gr.addColorStop(1,'#0e1a09');
  mc.fillStyle=gr; mc.fillRect(0,gY,W,H-gY);
  mc.strokeStyle='rgba(80,130,50,.45)'; mc.lineWidth=2;
  mc.beginPath(); mc.moveTo(0,gY); mc.lineTo(W,gY); mc.stroke();
  return bgCache;
}

// â”€â”€ Target ç±» â”€â”€
class Target {
  constructor(mode){
    this.mode = mode;
    this.alive = true; this.dying = false; this.dyingTimer = 0;
    // dyingReason: 'killed'(è¢«å‡»æ€â†’çº¢) | 'timeout'(è¶…æ—¶â†’è“)
    this.dyingReason = 'killed';
    this.hp = HP_MAX; this.maxHp = HP_MAX;
    this.born = Date.now();
    this.hits = 0; this.headshots = 0;

    // è·ç¦» â†’ ç¼©æ”¾
    this.dist  = DIST_MIN + Math.random() * (DIST_MAX - DIST_MIN);
    this.scale = this.dist;
    const s = this.scale;

    // äººä½“å„å°ºå¯¸
    const totalH   = TOTAL_H_BASE * s;
    this.headR     = totalH * HEAD_FRAC / 2;
    this.torsoH    = totalH * TORSO_FRAC;
    this.legH      = totalH * LEG_FRAC;
    this.shoulderW = this.headR * 2 * TORSO_W_RATIO;
    this.waistW    = this.shoulderW * WAIST_W_RATIO;
    this.armW      = this.headR * 2 * ARM_W_RATIO;
    this.legW      = this.headR * 2 * LEG_W_RATIO;
    // è„–å­é«˜åº¦ï¼ˆæ¯” headR çŸ­ï¼šä»… 0.4 å€å¤´åŠå¾„ï¼‰
    this.neckH     = this.headR * 0.4;

    // è„šçš„ Y åæ ‡ï¼ˆè¿‘å¤§è¿œå°ï¼Œè¿œçš„é è¿‘åœ°å¹³çº¿ï¼‰
    const gY   = H * GROUND_RATIO;
    const dNorm = (this.dist - DIST_MIN) / (DIST_MAX - DIST_MIN);
    this.footY     = gY - dNorm * (gY * 0.28) + (Math.random()-0.5) * H * 0.04;
    this.baseFootY = this.footY;

    // å‡ºç°ä½ç½®ï¼š65% éšæœºå±å¹•å†…ï¼Œ35% ä»è¾¹ç¼˜è¿›å…¥
    const fromEdge = (mode === 'peek') || Math.random() < 0.35;
    if(fromEdge){
      this.dir = Math.random() < 0.5 ? 1 : -1;
      this.x   = this.dir > 0 ? -50 : W + 50;
    } else {
      this.x   = W * 0.08 + Math.random() * W * 0.84;
      this.dir = Math.random() < 0.5 ? 1 : -1;
    }

    // é€Ÿåº¦ï¼ˆå»æ‰ patrolï¼Œé»˜è®¤ç”¨ sprint èŒƒå›´ï¼‰
    const speedRanges = {sprint:[180,340], peek:[0,0], multi:[90,250]};
    const [mn, mx] = speedRanges[mode] || [180,340];
    this.speed = (mn + Math.random() * (mx - mn)) * s;

    // æŠ˜è¿”ï¼šæ¦‚ç‡æå‡ï¼ˆçº¦æ¯0.6~1.2ç§’ä¸€æ¬¡ï¼‰
    this.lastReverseTime  = Date.now() + Math.random() * 400;
    this.reverseCooldown  = 400 + Math.random() * 700;
    this.reverseChance    = 0.025; // æå‡è‡³2.5%/å¸§

    // è·³è·ƒï¼šæ¦‚ç‡æå‡ï¼Œå†·å´ç¼©çŸ­
    this.vy = 0; this.jumping = false;
    this.lastJumpTime  = Date.now() + Math.random() * 1000;
    this.jumpCooldown  = 600 + Math.random() * 1500;  // åŸ1200~4200ï¼Œç°600~2100

    // æ¢å¤´æ¨¡å¼
    if(mode === 'peek'){
      this.peekState    = 'in';
      this.peekEdge     = this.dir > 0
        ? W * 0.1 + Math.random() * W * 0.4
        : W * 0.5 + Math.random() * W * 0.35;
      this.peekDuration = 500 + Math.random() * 900;
      this.peekVisible  = 0;
      this.speed        = (220 + Math.random() * 140) * s;
      this.x = this.dir > 0 ? this.peekEdge - 80 : this.peekEdge + 80;
    }

    this.walkPhase = Math.random() * Math.PI * 2;
    this.color = {
      skin:'#c8a882', torso:'#3a5a4a', pants:'#2e3e2e',
      boots:'#1a1a1a', helmet:'#3a5a4a'
    };
  }

  // å…³é”® Y åæ ‡ï¼ˆè„–å­ç¼©çŸ­ï¼šshoulderY æ›´é è¿‘å¤´ï¼‰
  get headCY(){ return this.footY - this.legH - this.torsoH - this.neckH - this.headR; }
  get shoulderY(){ return this.headCY + this.headR + this.neckH; }
  get hipY(){ return this.shoulderY + this.torsoH; }
  get kneeY(){ return this.hipY + this.legH * 0.52; }

  update(dt){
    if(!this.alive) return;
    if(this.dying){
      this.dyingTimer += dt * 1000;
      if(this.dyingTimer > 380){
        // è¶…æ—¶æ¶ˆå¤±æ—¶ï¼Œé€šçŸ¥ GS è®¡æ•°
        if(this.dyingReason === 'timeout') GS.escaped++;
        this.alive = false;
      }
      return;
    }
    // è¶…æ—¶æ¶ˆå¤±ï¼ˆè“è‰²ï¼‰
    if(Date.now() - this.born > TARGET_LIFETIME){
      this.dying = true; this.dyingTimer = 0;
      this.dyingReason = 'timeout';
      return;
    }

    // è·³è·ƒï¼ˆæ¦‚ç‡æå‡ï¼š0.025/å¸§çº¦æ¯0.7~1.5ç§’ä¸€æ¬¡ï¼‰
    const now = Date.now();
    if(!this.jumping && now - this.lastJumpTime > this.jumpCooldown && this.mode !== 'peek'){
      if(Math.random() < 0.025){
        this.jumping = true;
        this.vy = -(320 + Math.random() * 200) * this.scale;
        this.lastJumpTime = now;
        this.jumpCooldown = 600 + Math.random() * 1500;
      }
    }
    if(this.jumping){
      this.vy += 900 * this.scale * dt;
      this.footY += this.vy * dt;
      if(this.footY >= this.baseFootY){
        this.footY = this.baseFootY; this.vy = 0; this.jumping = false;
      }
    }

    this.walkPhase += dt * 14; // ç»Ÿä¸€å†²åˆºæ­¥é¢‘

    // æ°´å¹³ç§»åŠ¨
    if(this.mode === 'peek'){
      if(this.peekState === 'in'){
        this.x += this.dir * this.speed * dt;
        const reached = this.dir > 0 ? this.x >= this.peekEdge : this.x <= this.peekEdge;
        if(reached){ this.x = this.peekEdge; this.peekState = 'visible'; this.peekVisible = Date.now(); }
      } else if(this.peekState === 'visible'){
        if(Date.now() - this.peekVisible > this.peekDuration) this.peekState = 'out';
      } else {
        this.x -= this.dir * this.speed * dt;
        const gone = this.dir > 0 ? this.x < this.peekEdge - 120 : this.x > this.peekEdge + 120;
        if(gone) this.alive = false;
      }
    } else {
      // éšæœºæŠ˜è¿”ï¼ˆæ¦‚ç‡æå‡ï¼‰
      if(now - this.lastReverseTime > this.reverseCooldown && Math.random() < this.reverseChance){
        this.dir *= -1;
        this.lastReverseTime = now;
        this.reverseCooldown = 400 + Math.random() * 700;
      }
      this.x += this.dir * this.speed * dt;
      if(this.x < -100 || this.x > W + 100) this.alive = false;
    }
  }

  draw(ctx){
    if(!this.alive) return;
    const x = this.x, s = this.scale;
    const headCY    = this.headCY;
    const shoulderY = this.shoulderY;
    const hipY      = this.hipY;
    const kneeY     = this.kneeY;
    const foot      = this.footY;
    const gd        = this.dir;
    const alpha     = this.dying ? Math.max(0, 1 - this.dyingTimer/380) : 1;

    // é¢œè‰²ä¸»é¢˜ï¼šæ­£å¸¸/ä½è¡€é—ªçƒ/è¢«å‡»æ€(çº¢)/è¶…æ—¶(è“)
    const lowFlash = !this.dying && this.hp < 50 && Math.floor(Date.now()/120) % 2 === 0;
    let tintColor = null;
    if(this.dying && this.dyingReason === 'killed')  tintColor = '#ff3366';
    if(this.dying && this.dyingReason === 'timeout') tintColor = '#00aaff';
    if(lowFlash) tintColor = '#ff3366';

    ctx.save();
    ctx.globalAlpha = alpha;

    const skinC  = tintColor || this.color.skin;
    const torsoC = tintColor || this.color.torso;
    const pantsC = tintColor || this.color.pants;
    const bootsC = tintColor || this.color.boots;
    const helmC  = tintColor || this.color.helmet;

    // é˜´å½±
    ctx.fillStyle = 'rgba(0,0,0,.2)';
    ctx.beginPath(); ctx.ellipse(x, foot+2*s, this.shoulderW*0.8, 3*s, 0, 0, Math.PI*2); ctx.fill();

    const walkSwing = Math.sin(this.walkPhase) * (this.jumping ? 0 : (this.mode==='sprint' ? 14 : 9));

    // â”€â”€ è…¿ï¼ˆå‰åè…¿ï¼Œä¸¤æ®µï¼šå¤§è…¿+å°è…¿ï¼‰â”€â”€
    ctx.lineCap = 'round'; ctx.lineJoin = 'round';

    // åè…¿ï¼ˆç¨æš—ï¼‰
    ctx.globalAlpha = alpha * 0.72;
    const lLegOffX = -this.shoulderW * 0.22;
    const rLegOffX =  this.shoulderW * 0.22;

    // å¤§è…¿
    ctx.strokeStyle = pantsC; ctx.lineWidth = this.legW * 1.05;
    ctx.beginPath(); ctx.moveTo(x + rLegOffX, hipY); ctx.lineTo(x + rLegOffX - walkSwing*s, kneeY); ctx.stroke();
    // å°è…¿
    ctx.lineWidth = this.legW * 0.85;
    ctx.beginPath(); ctx.moveTo(x + rLegOffX - walkSwing*s, kneeY); ctx.lineTo(x + rLegOffX - walkSwing*s*0.5, foot); ctx.stroke();
    // é´å­
    ctx.strokeStyle = bootsC; ctx.lineWidth = this.legW * 0.9;
    ctx.beginPath(); ctx.moveTo(x + rLegOffX - walkSwing*s*0.5, foot); ctx.lineTo(x + rLegOffX - walkSwing*s*0.5 + gd*3*s, foot - this.legH*0.07); ctx.stroke();

    // å‰è…¿
    ctx.globalAlpha = alpha;
    ctx.strokeStyle = pantsC; ctx.lineWidth = this.legW * 1.05;
    ctx.beginPath(); ctx.moveTo(x + lLegOffX, hipY); ctx.lineTo(x + lLegOffX + walkSwing*s, kneeY); ctx.stroke();
    ctx.lineWidth = this.legW * 0.85;
    ctx.beginPath(); ctx.moveTo(x + lLegOffX + walkSwing*s, kneeY); ctx.lineTo(x + lLegOffX + walkSwing*s*0.5, foot); ctx.stroke();
    ctx.strokeStyle = bootsC; ctx.lineWidth = this.legW * 0.9;
    ctx.beginPath(); ctx.moveTo(x + lLegOffX + walkSwing*s*0.5, foot); ctx.lineTo(x + lLegOffX + walkSwing*s*0.5 + gd*3*s, foot - this.legH*0.07); ctx.stroke();

    // â”€â”€ èº¯å¹²ï¼ˆæ¢¯å½¢ï¼šè‚©å®½>è…°å®½ï¼‰â”€â”€
    const sw = this.shoulderW, ww = this.waistW;
    ctx.fillStyle = torsoC; ctx.strokeStyle = flash ? '#ff3366' : '#1e3a1e'; ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(x - sw/2, shoulderY);
    ctx.lineTo(x + sw/2, shoulderY);
    ctx.lineTo(x + ww/2, hipY);
    ctx.lineTo(x - ww/2, hipY);
    ctx.closePath(); ctx.fill(); ctx.stroke();

    // â”€â”€ æ­¦å™¨ â”€â”€
    ctx.fillStyle = flash ? '#ff3366' : '#1a1a1a';
    ctx.save();
    ctx.translate(x + gd * sw * 0.52, shoulderY + this.torsoH * 0.3);
    const gunL = this.headR * 3.6;
    const gunH = this.headR * 0.45;
    ctx.fillRect(gd > 0 ? 0 : -gunL, -gunH/2, gunL, gunH);
    ctx.fillRect(gd > 0 ? -gunH : -gunH, -gunH*1.3, gunH*1.2, gunH*2);
    ctx.restore();

    // â”€â”€ æ‰‹è‡‚ï¼ˆåè‡‚åæš—ï¼‰â”€â”€
    const armY1 = shoulderY + 2*s;
    const elbowOff = this.headR * 2.0;
    const wristOff = this.headR * 1.8;
    const armSwing = -Math.sin(this.walkPhase) * 6;
    // åè‡‚
    ctx.globalAlpha = alpha * 0.72;
    ctx.strokeStyle = torsoC; ctx.lineWidth = this.armW;
    ctx.beginPath(); ctx.moveTo(x + sw/2, armY1); ctx.lineTo(x + gd*elbowOff*0.5, armY1 + elbowOff + armSwing*s); ctx.stroke();
    ctx.strokeStyle = skinC;
    ctx.beginPath(); ctx.moveTo(x + gd*elbowOff*0.5, armY1 + elbowOff + armSwing*s); ctx.lineTo(x + gd*elbowOff*0.9, armY1 + elbowOff + wristOff*0.7 + armSwing*s); ctx.stroke();
    // å‰è‡‚
    ctx.globalAlpha = alpha;
    ctx.strokeStyle = torsoC; ctx.lineWidth = this.armW;
    ctx.beginPath(); ctx.moveTo(x - sw/2, armY1); ctx.lineTo(x - gd*elbowOff*0.4, armY1 + elbowOff - armSwing*s); ctx.stroke();
    ctx.strokeStyle = skinC;
    ctx.beginPath(); ctx.moveTo(x - gd*elbowOff*0.4, armY1 + elbowOff - armSwing*s); ctx.lineTo(x - gd*elbowOff*0.1, armY1 + elbowOff + wristOff*0.55 - armSwing*s); ctx.stroke();

    // â”€â”€ è„–å­ï¼ˆçŸ­ï¼‰â”€â”€
    ctx.strokeStyle = skinC; ctx.lineWidth = this.headR * 0.55; ctx.lineCap = 'round';
    ctx.beginPath(); ctx.moveTo(x, shoulderY); ctx.lineTo(x, headCY + this.headR); ctx.stroke();

    // â”€â”€ å¤´éƒ¨ â”€â”€
    ctx.fillStyle = skinC; ctx.strokeStyle = flash ? '#ff3366' : '#a07050'; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.arc(x, headCY, this.headR, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    // å¤´ç›”
    ctx.fillStyle = helmC;
    ctx.beginPath(); ctx.ellipse(x, headCY - this.headR*0.12, this.headR + 2*s, this.headR*0.68, 0, Math.PI, 0); ctx.fill();
    // æŠ¤ç›®é•œ
    ctx.fillStyle = 'rgba(0,200,230,0.28)';
    ctx.beginPath(); ctx.ellipse(x + gd*this.headR*0.22, headCY + this.headR*0.08, this.headR*0.62, this.headR*0.3, 0, 0, Math.PI*2); ctx.fill();

    // â”€â”€ è¡€æ¡ â”€â”€
    if(!this.dying && this.hp < this.maxHp){
      const bw = sw * 1.5, bh = 4*s;
      const bx = x - bw/2, by = headCY - this.headR - 11*s;
      ctx.fillStyle = 'rgba(0,0,0,.55)'; ctx.fillRect(bx, by, bw, bh);
      const pct = this.hp / this.maxHp;
      ctx.fillStyle = pct > 0.5 ? '#00ff88' : pct > 0.25 ? '#ffaa00' : '#ff3366';
      ctx.fillRect(bx, by, bw*pct, bh);
      ctx.strokeStyle = 'rgba(255,255,255,.2)'; ctx.lineWidth = .5;
      ctx.strokeRect(bx, by, bw, bh);
    }

    ctx.restore();
  }

  checkHit(mx, my){
    const headCY    = this.headCY;
    const shoulderY = this.shoulderY;
    const hipY      = this.hipY;
    const foot      = this.footY;
    const s         = this.scale;
    // å¤´éƒ¨
    if(Math.hypot(mx - this.x, my - headCY) < this.headR + 4*s) return 'head';
    // èº¯å¹²
    const tx1 = this.x - this.shoulderW/2 - 3, tx2 = this.x + this.shoulderW/2 + 3;
    if(mx > tx1 && mx < tx2 && my > shoulderY - 3 && my < hipY + 4) return 'body';
    // è…¿
    const lx1 = this.x - this.shoulderW*0.55, lx2 = this.x + this.shoulderW*0.55;
    if(mx > lx1 && mx < lx2 && my > hipY && my < foot + 5) return 'limb';
    // æ‰‹è‡‚èŒƒå›´
    if(mx > this.x - this.shoulderW*1.1 && mx < this.x + this.shoulderW*1.1
       && my > shoulderY && my < hipY + this.headR*2) return 'limb';
    return null;
  }

  takeDamage(type){
    const dmg = type === 'head' ? DMG_HEAD : type === 'limb' ? DMG_LIMB : DMG_BODY;
    this.hp = Math.max(0, this.hp - dmg);
    if(type === 'head') this.headshots++;
    this.hits++;
    if(this.hp <= 0 && !this.dying){
      this.dying = true; this.dyingTimer = 0;
      this.dyingReason = 'killed';
      return true;
    }
    return false;
  }
}

// â”€â”€ æ¸¸æˆçŠ¶æ€ â”€â”€
let GS = {
  running: false, mode: 'sprint',
  kills: 0, hits: 0, misses: 0, headshots: 0, combo: 0, maxCombo: 0,
  escaped: 0,
  shotsFired: 0, reactionTimes: [],
  timeLeft: 60, targets: [], animFrame: null, timer: null, spawnInterval: null,
  lastFrame: 0,
};

// â”€â”€ é¼ æ ‡äº‹ä»¶ï¼ˆåœ¨ GS å£°æ˜åç»‘å®šï¼‰â”€â”€
wrap.addEventListener('mousedown', e => {
  if(e.button !== 0 || !GS.running) return;
  mouseDown = true;
  doShoot();
  shootTimer = setInterval(doShoot, FIRE_RATE);
});
document.addEventListener('mouseup', e => {
  if(e.button !== 0) return;
  mouseDown = false;
  clearInterval(shootTimer); shootTimer = null;
});
wrap.addEventListener('mouseleave', () => {
  mouseDown = false;
  clearInterval(shootTimer); shootTimer = null;
});
wrap.addEventListener('contextmenu', e => e.preventDefault());

function setMode(m){
  GS.mode = m;
  document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('btn-' + m).classList.add('active');
}

function toggleGame(){ GS.running ? stopGame() : startGame(); }

function startGame(){
  document.getElementById('start-overlay').style.display = 'none';
  document.getElementById('result-modal').classList.remove('show');
  recoilY = 0; recoilX = 0;
  Object.assign(GS, {
    running:true, kills:0, hits:0, misses:0, headshots:0,
    combo:0, maxCombo:0, shotsFired:0, reactionTimes:[],
    escaped:0,
    timeLeft:60, targets:[], lastFrame:performance.now(),
  });
  const btn = document.getElementById('startBtn');
  btn.textContent = 'â¹ åœæ­¢'; btn.classList.add('stop');
  updateHUD(); spawnTargets();
  const ms = {sprint:1600, peek:2000, multi:1200}[GS.mode] || 1600;
  GS.spawnInterval = setInterval(spawnTargets, ms);
  GS.timer = setInterval(() => {
    GS.timeLeft--;
    document.getElementById('hud-time').textContent = GS.timeLeft + 's';
    if(GS.timeLeft <= 0) stopGame(true);
  }, 1000);
  requestAnimationFrame(gameLoop);
}

function spawnTargets(){
  if(!GS.running) return;
  GS.targets = GS.targets.filter(t => t.alive);
  const max = {sprint:1, peek:1, multi:3}[GS.mode] || 1;
  const need = max - GS.targets.length;
  for(let i = 0; i < need; i++) GS.targets.push(new Target(GS.mode));
}

function gameLoop(ts){
  if(!GS.running) return;
  const dt = Math.min((ts - GS.lastFrame) / 1000, 0.05);
  GS.lastFrame = ts;

  // åååŠ›æ¢å¤
  const recovDt = RECOIL_RECOVERY * dt;
  recoilY = Math.max(0, recoilY - recovDt);
  recoilX = recoilX * (1 - dt * 8); // æ°´å¹³å¿«é€Ÿè¡°å‡

  GS.targets.forEach(t => t.update(dt));
  GS.targets = GS.targets.filter(t => t.alive);
  // å®æ—¶åŒæ­¥æ¼æ‰æ•°
  document.getElementById('hud-escaped').textContent = GS.escaped;
  drawScene();
  GS.animFrame = requestAnimationFrame(gameLoop);
}

function drawScene(){
  ctx.clearRect(0, 0, W, H);
  try{ ctx.drawImage(getBg(), 0, 0); } catch(e){}
  if(GS.mode === 'peek') drawCover();
  GS.targets.sort((a,b) => b.dist - a.dist).forEach(t => t.draw(ctx));
}

function drawCover(){
  const gY = H * GROUND_RATIO;
  [[W*.12,gY-44,60,44],[W*.52,gY-52,68,52],[W*.78,gY-38,54,38]].forEach(([x,y,w,h]) => {
    ctx.fillStyle = '#3a3020'; ctx.strokeStyle = '#252010'; ctx.lineWidth = 2;
    ctx.fillRect(x,y,w,h); ctx.strokeRect(x,y,w,h);
    ctx.fillStyle = '#4a3828';
    ctx.fillRect(x+5,y+7,w-10,10); ctx.fillRect(x+5,y+22,w-10,10);
  });
}

// â”€â”€ å°„å‡»ï¼ˆå«åååŠ›ï¼‰â”€â”€
function doShoot(){
  if(!GS.running) return;

  // ç´¯åŠ åååŠ›
  recoilY = Math.min(RECOIL_MAX, recoilY + RECOIL_PER_SHOT);
  recoilX += (Math.random() - 0.5) * 2 * RECOIL_HORIZ;

  // å®é™…å°„å‡»ä½ç½® = å‡†æ˜Ÿ + åååŠ›åç§»
  const rect = canvas.getBoundingClientRect();
  const scaleX = W / rect.width, scaleY = H / rect.height;
  const cx = mouseX * scaleX + recoilX;
  const cy = mouseY * scaleY - recoilY;

  GS.shotsFired++;

  const sorted = [...GS.targets].sort((a,b) => a.dist - b.dist);
  let hitAny = false;
  for(const t of sorted){
    if(!t.alive || t.dying) continue;
    const part = t.checkHit(cx, cy);
    if(part){
      const killed = t.takeDamage(part);
      GS.hits++;
      if(part === 'head') GS.headshots++;
      if(killed){ GS.kills++; GS.combo++; if(GS.combo > GS.maxCombo) GS.maxCombo = GS.combo; }
      GS.reactionTimes.push(Date.now() - t.born);
      hitAny = true;
      showFx(mouseX, mouseY, part, killed);
      updateHUD();
      break;
    }
  }
  if(!hitAny){
    GS.misses++; GS.combo = 0;
    showFx(mouseX, mouseY, 'miss', false);
    updateHUD();
  }
}

function showFx(x, y, type, killed){
  const el = document.createElement('div');
  el.className = 'fx' + (type==='head' ? ' hs' : type==='miss' ? ' miss' : '');
  el.style.left = (x - 18) + 'px'; el.style.top = (y - 12) + 'px';
  if(type === 'head')      el.textContent = killed ? 'ğŸ’¥ çˆ†å¤´å‡»æ€!' : 'ğŸ’¥ çˆ†å¤´ -50';
  else if(type === 'body') el.textContent = killed ? 'â˜ ï¸ å‡»æ€!' : '-25';
  else if(type === 'limb') el.textContent = killed ? 'â˜ ï¸ å‡»æ€!' : 'ğŸ¦µ -12';
  else                     el.textContent = 'âœ—';
  wrap.appendChild(el);
  setTimeout(() => el.remove(), 650);
}

function updateHUD(){
  const total = GS.hits + GS.misses;
  const acc   = total > 0 ? Math.round(GS.hits / total * 100) + '%' : '-';
  const hs    = GS.hits > 0 ? Math.round(GS.headshots / GS.hits * 100) + '%' : '-';
  document.getElementById('hud-kills').textContent   = GS.kills;
  document.getElementById('hud-escaped').textContent = GS.escaped;
  document.getElementById('hud-hits').textContent    = GS.hits;
  document.getElementById('hud-miss').textContent    = GS.misses;
  document.getElementById('hud-acc').textContent     = acc;
  document.getElementById('hud-hs').textContent      = hs;
  document.getElementById('hud-combo').textContent   = 'x' + GS.combo;
}

function stopGame(showResult=true){
  GS.running = false;
  clearInterval(GS.timer); clearInterval(GS.spawnInterval);
  clearInterval(shootTimer); mouseDown = false;
  cancelAnimationFrame(GS.animFrame);
  ctx.clearRect(0, 0, W, H);
  const btn = document.getElementById('startBtn');
  btn.textContent = 'å¼€å§‹è®­ç»ƒ'; btn.classList.remove('stop');
  document.getElementById('hud-time').textContent = '60s';
  if(showResult && (GS.hits + GS.misses > 0)) showResultModal();
  else document.getElementById('start-overlay').style.display = 'flex';
}

// â”€â”€ è¯„çº§ï¼šä»…æ ¹æ®å•ä½æ—¶é—´å‡»æ€æ•°ï¼ˆå‡»æ€/åˆ†é’Ÿï¼‰â”€â”€
function calcGrade(killsPerMin){
  // 60ç§’å±€ï¼Œæ»¡åˆ†å‚è€ƒï¼šSâ‰¥30/min, Aâ‰¥20, Bâ‰¥12, C<12
  if(killsPerMin >= 30) return 'S';
  if(killsPerMin >= 20) return 'A';
  if(killsPerMin >= 12) return 'B';
  return 'C';
}

function showResultModal(){
  const total = GS.hits + GS.misses;
  const acc   = total > 0 ? Math.round(GS.hits / total * 100) : 0;
  const hs    = GS.hits > 0 ? Math.round(GS.headshots / GS.hits * 100) : 0;
  const avgRt = GS.reactionTimes.length > 0
    ? Math.round(GS.reactionTimes.reduce((a,b) => a+b, 0) / GS.reactionTimes.length)
    : 0;

  // è¯„çº§ï¼šå‡»æ€/åˆ†é’Ÿï¼ˆæ€»æ—¶é•¿å›ºå®š60ç§’ï¼‰
  const killsPerMin = GS.kills; // 60ç§’å±€ = kills * 60/60 = kills/min
  const grade = calcGrade(killsPerMin);
  const gc = {S:'#00d4ff', A:'#00ff88', B:'#ff6b35', C:'#64748b'}[grade];
  const mn = {patrol:'å·¡é€»', sprint:'å†²åˆº', peek:'æ¢å¤´', multi:'å¤šç›®æ ‡'};
  const gradeDesc = {
    S:'ç²¾è‹±å°„æ‰‹ ğŸŒŸ', A:'è€å…µæ°´å¹³ ğŸ’ª', B:'ç»§ç»­ç»ƒä¹  ğŸ“ˆ', C:'åŠ æ²¹è®­ç»ƒ ğŸ¯'
  }[grade];

  document.getElementById('result-body').innerHTML = `
    <div class="result-row"><span>æ¨¡å¼</span><span class="val">${mn[GS.mode]}</span></div>
    <div class="result-row"><span>æ€»å‡»æ€</span><span class="val">${GS.kills}</span></div>
    <div class="result-row"><span>ğŸ’¨ æ¼æ‰</span><span class="val" style="color:var(--red)">${GS.escaped}</span></div>
    <div class="result-row"><span>å‡»æ€/åˆ†é’Ÿ</span><span class="val" style="color:${gc}">${killsPerMin}</span></div>
    <div class="result-row"><span>å‘½ä¸­ / å°„å‡»</span><span class="val">${GS.hits} / ${total}</span></div>
    <div class="result-row"><span>å‘½ä¸­ç‡</span><span class="val">${acc}%</span></div>
    <div class="result-row"><span>çˆ†å¤´ç‡</span><span class="val" style="color:#ffd700">${hs}%</span></div>
    <div class="result-row"><span>å¹³å‡ååº”æ—¶é—´</span><span class="val">${avgRt}ms</span></div>
    <div class="result-row"><span>æœ€é«˜è¿å‡»</span><span class="val">x${GS.maxCombo}</span></div>
    <div class="result-row"><span>è¯„çº§</span><span class="val" style="color:${gc};font-size:22px">${grade} <small style="font-size:13px">${gradeDesc}</small></span></div>
  `;
  document.getElementById('result-modal').classList.add('show');
  saveRecord({acc, hs, avgRt, kills:GS.kills, killsPerMin, combo:GS.maxCombo, grade,
    hits:GS.hits, total, mode:GS.mode, time:new Date().toLocaleString('zh-CN')});
}

function retryGame(){ closeResult(); setTimeout(startGame, 80); }
function closeResult(){
  document.getElementById('result-modal').classList.remove('show');
  document.getElementById('start-overlay').style.display = 'flex';
}

// â”€â”€ çµæ•åº¦é¡µ â”€â”€
let sensCtx2, sensT, sMX=-1, sMY=-1, sensAnim;
function initSensCanvas(){
  if(sensAnim) cancelAnimationFrame(sensAnim);
  const sc = document.getElementById('sensCanvas');
  sc.width = sc.parentElement.clientWidth - 40; sc.height = 180;
  sensCtx2 = sc.getContext('2d');
  const gY = sc.height * 0.72;
  sensT = {x: sc.width/2, foot: gY, vx: 1.5};
  sc.addEventListener('mousemove', e => {
    const r = sc.getBoundingClientRect();
    sMX = (e.clientX - r.left) * (sc.width / r.width);
    sMY = (e.clientY - r.top)  * (sc.height / r.height);
  });
  (function loop(){
    const w=sc.width, h=sc.height, gY2=sensT.foot;
    sensCtx2.fillStyle='#0a0e1a'; sensCtx2.fillRect(0,0,w,h);
    sensCtx2.fillStyle='#1a2a14'; sensCtx2.fillRect(0,gY2,w,h-gY2);
    sensCtx2.strokeStyle='rgba(80,130,50,.35)'; sensCtx2.lineWidth=1;
    sensCtx2.beginPath(); sensCtx2.moveTo(0,gY2); sensCtx2.lineTo(w,gY2); sensCtx2.stroke();
    sensT.x += sensT.vx; if(sensT.x<30||sensT.x>w-30) sensT.vx*=-1;
    const tx=sensT.x, s=0.8;
    const tHeadR=9*s, tTorsoH=35*s, tLegH=45*s;
    const tFoot=gY2, tHeadCY=tFoot-tLegH-tTorsoH-tHeadR;
    sensCtx2.fillStyle='#4a7a5a';
    sensCtx2.beginPath();
    sensCtx2.moveTo(tx-12*s, tHeadCY+tHeadR*2);
    sensCtx2.lineTo(tx+12*s, tHeadCY+tHeadR*2);
    sensCtx2.lineTo(tx+9*s, tHeadCY+tHeadR*2+tTorsoH);
    sensCtx2.lineTo(tx-9*s, tHeadCY+tHeadR*2+tTorsoH);
    sensCtx2.closePath(); sensCtx2.fill();
    sensCtx2.fillStyle='#c8a882';
    sensCtx2.beginPath(); sensCtx2.arc(tx, tHeadCY, tHeadR, 0, Math.PI*2); sensCtx2.fill();
    if(sMX > 0){
      sensCtx2.strokeStyle='rgba(0,212,255,.25)'; sensCtx2.setLineDash([4,6]);
      sensCtx2.beginPath(); sensCtx2.moveTo(sMX,sMY); sensCtx2.lineTo(tx,tHeadCY); sensCtx2.stroke();
      sensCtx2.setLineDash([]);
      sensCtx2.fillStyle='#00d4ff'; sensCtx2.shadowColor='#00d4ff'; sensCtx2.shadowBlur=7;
      sensCtx2.beginPath(); sensCtx2.arc(sMX,sMY,4,0,Math.PI*2); sensCtx2.fill();
      sensCtx2.shadowBlur=0;
    }
    sensAnim = requestAnimationFrame(loop);
  })();
  updateSens();
}

function updateSens(){
  const dpi = +document.getElementById('dpi').value;
  const igs = +document.getElementById('igs').value;
  const ads = +document.getElementById('ads').value;
  document.getElementById('dpi-val').textContent = dpi;
  document.getElementById('igs-val').textContent = igs;
  document.getElementById('ads-val').textContent = ads.toFixed(2);
  const eDPI  = dpi * (igs/100) * 2;
  const cm360 = (2.54 * 360) / (eDPI * 0.022);
  document.getElementById('cm360').textContent     = cm360.toFixed(1);
  document.getElementById('conv-delta').textContent = igs;
  document.getElementById('conv-cs').textContent    = (eDPI/dpi/3.18).toFixed(2);
  document.getElementById('conv-val').textContent   = (eDPI/dpi/3.18*1.2).toFixed(2);
  document.getElementById('conv-pubg').textContent  = Math.round(igs*0.8);
  document.getElementById('conv-apex').textContent  = (eDPI/dpi/3.18*1.5).toFixed(2);
  document.getElementById('conv-ow').textContent    = (eDPI/dpi/3.18*10.6).toFixed(1);
}

// â”€â”€ ç»Ÿè®¡ â”€â”€
function saveRecord(r){
  const h = JSON.parse(localStorage.getItem('aimtrainer_v3') || '[]');
  h.unshift(r); if(h.length > 50) h.pop();
  localStorage.setItem('aimtrainer_v3', JSON.stringify(h));
}
function renderStats(){
  const h = JSON.parse(localStorage.getItem('aimtrainer_v3') || '[]');
  document.getElementById('s-total').textContent = h.length;
  if(h.length){
    document.getElementById('s-avgacc').textContent = Math.round(h.reduce((a,b)=>a+b.acc,0)/h.length) + '%';
    const rts = h.filter(r => r.avgRt > 0);
    document.getElementById('s-avgrt').textContent = rts.length
      ? Math.round(rts.reduce((a,b)=>a+b.avgRt,0)/rts.length) + 'ms' : '-';
    document.getElementById('s-combo').textContent = Math.max(...h.map(r=>r.combo));
  }
  const tbody = document.getElementById('history-body');
  if(!h.length){
    tbody.innerHTML='<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:22px">æš‚æ— è®°å½• ğŸ¯</td></tr>';
    return;
  }
  const mn = {sprint:'å†²åˆº', peek:'æ¢å¤´', multi:'å¤šç›®æ ‡'};
  tbody.innerHTML = h.map(r => `<tr>
    <td>${r.time}</td>
    <td>${mn[r.mode]||r.mode}</td>
    <td>${r.kills||0}</td>
    <td>${r.acc}%</td>
    <td style="color:#ffd700">${r.hs||0}%</td>
    <td>${r.avgRt||'-'}ms</td>
    <td>x${r.combo}</td>
    <td><span class="tag tag-${r.grade.toLowerCase()}">${r.grade}</span></td>
  </tr>`).join('');
}
function clearHistory(){
  if(confirm('ç¡®å®šæ¸…é™¤æ‰€æœ‰è®­ç»ƒè®°å½•ï¼Ÿ')){
    localStorage.removeItem('aimtrainer_v3'); renderStats();
  }
}
</script>
</body>
</html>
